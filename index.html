<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pintar | Aplikasi Scanner Kartu Nama & QR Code Berbasis AI</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar.ico" type="image/x-icon">

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#4f46e5"/>

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Pintar">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid rgba(0,0,0,0.1); border-top-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: rgba(255,255,255,0.2); border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.6)); }
        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 80%; max-width: 320px; aspect-ratio: 1/1; border: 2px dashed rgba(255,255,255,0.5); border-radius: 1.5rem; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-button { padding: .75rem 1.25rem; height: 48px; display: inline-flex; align-items: center; justify-content: center; text-align: center; font-weight: 600; border-radius: .5rem; transition: all .2s ease-in-out; white-space: nowrap; }
        #scan-mode-label { transition: opacity .3s ease; }
        .btn-loader { width: 20px !important; height: 20px !important; border-width: 2px !important; }
        #qr-code-container { display: flex; justify-content: center; align-items: center; background: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        #log-icon { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; }
        #log-viewer-modal .log-entry { border-bottom: 1px solid #4a5568; }
        #log-viewer-modal .log-entry:last-child { border-bottom: none; }
        .contact-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .contact-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dark .contact-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="app-container max-w-lg mx-auto shadow-2xl min-h-screen flex flex-col bg-gray-50 dark:bg-[#0D1117] relative">
        <div id="collaboration-mode-indicator" class="hidden sticky top-0 bg-indigo-600 text-white text-xs text-center p-2 z-20 shadow-lg">
            <strong data-translate-key="collabMode">Mode Kolaborasi:</strong> <span id="collab-session-name"></span> | <strong data-translate-key="collabUser">User:</strong> <span id="collab-user-name"></span>
            <button id="exit-collab-btn" class="absolute top-1/2 right-2 -translate-y-1/2 text-indigo-200 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <main class="main-content flex-grow flex flex-col">
            <div id="initial-screen" class="screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                 <div class="absolute top-5 right-5 z-30 flex items-center gap-2">
                    <button id="lang-toggle-initial" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">EN</button>
                    <button id="profile-settings-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                        <i data-lucide="user" class="sm:hidden w-5 h-5"></i>
                        <span class="hidden sm:inline" data-translate-key="profileBtn">PROFIL</span>
                    </button>
                    <button id="theme-toggle-initial" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                        <i data-lucide="sun" class="sm:hidden w-5 h-5"></i>
                        <i data-lucide="moon" class="sm:hidden w-5 h-5"></i>
                        <span class="hidden sm:inline" data-translate-key="themeBtn">TEMA</span>
                    </button>
                </div>
                <div class="w-full">
                    <div class="flex justify-center mb-8">
                        <img src="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar.png" alt="Logo Scanner Pintar" class="w-24 h-24 rounded-full">
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white" data-translate-key="appTitle">SCANNER PINTAR</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-2" data-translate-key="appSubtitle">Scanner Kartu Nama & QR Code Berbasis AI</p>
                </div>
                <div id="session-form-container" class="w-full text-left my-8 space-y-4">
                    <div><label for="session-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="eventNameLabel">Nama Acara</label><input type="text" id="session-acara" data-translate-key-placeholder="eventNamePlaceholder" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="session-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="dateLabel">Tanggal</label><input type="date" id="session-tanggal" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label for="session-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="notesLabel">Catatan</label><input type="text" id="session-catatan" data-translate-key-placeholder="notesPlaceholder" placeholder="Opsional" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    </div>
                </div>
                <div class="w-full flex flex-col gap-4">
                     <button id="start-scan-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg" data-translate-key="scanCardBtn">SCAN KARTU NAMA</button>
                     <button id="upload-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg" data-translate-key="uploadGalleryBtn">UPLOAD DARI GALERI</button>
                     <div class="border-t border-gray-200 dark:border-gray-700 w-3/4 mx-auto my-2"></div>
                     <button id="create-session-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center justify-center gap-3 text-base" data-translate-key="collabModeBtn">MODE KOLABURASI TIM</button>
                     <button id="view-results-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center gap-2 uppercase"><span data-translate-key="viewResultsBtn">LIHAT HASIL SCAN</span> <span id="home-contact-count" class="bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-2 py-0.5 rounded-full">0</span></button>
                </div>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
            </div>

            <div id="create-session-screen" class="hidden screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                <h2 class="text-2xl font-bold" data-translate-key="createCollabTitle">Buat Sesi Kolaborasi Baru</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2 mb-8" data-translate-key="createCollabSubtitle">Masukkan nama acara untuk membuat sesi yang dapat dibagikan.</p>
                <div class="w-full max-w-sm">
                     <label for="collab-session-name-input" class="text-sm font-medium text-gray-600 dark:text-gray-400 text-left block" data-translate-key="collabSessionNameLabel">Nama Acara / Sesi</label>
                     <input type="text" id="collab-session-name-input" data-translate-key-placeholder="collabSessionNamePlaceholder" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
                     <div class="flex gap-4 mt-6">
                        <button id="cancel-create-session-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-full" data-translate-key="cancelBtn">BATAL</button>
                        <button id="generate-session-qr-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-full uppercase" data-translate-key="createQrBtn">Buat QR Code</button>
                     </div>
                </div>
            </div>

            <div id="profile-screen" class="hidden screen flex-col"><header class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold" data-translate-key="myProfileTitle">Profil Saya</h2><button id="back-to-home-from-profile" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></header><div class="p-8 space-y-4 flex-grow"><div><label for="profile-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourNameLabel">Nama Anda</label><input type="text" id="profile-nama" data-translate-key-placeholder="yourNamePlaceholder" placeholder="Cth: Isparmo" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourPositionLabel">Jabatan Anda</label><input type="text" id="profile-jabatan" data-translate-key-placeholder="yourPositionPlaceholder" placeholder="Cth: Marketing Manager" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourCompanyLabel">Nama Perusahaan Anda</label><input type="text" id="profile-perusahaan" data-translate-key-placeholder="yourCompanyPlaceholder" placeholder="Cth: PT Multibangun Rekatama Patria" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-deskripsi" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="companyDescLabel">Deskripsi Singkat Perusahaan</label><textarea id="profile-deskripsi" rows="3" data-translate-key-placeholder="companyDescPlaceholder" placeholder="Cth: Spesialis Geosintetik sejak 1995..." class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea></div></div><footer class="p-6"><button id="save-profile-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full" data-translate-key="saveProfileBtn">SIMPAN PROFIL</button></footer></div>

            <div id="scanner-screen" class="hidden screen relative bg-black flex-grow"><video id="video" autoplay playsinline></video><div class="scan-frame"></div><div class="camera-overlay p-6"><div class="flex justify-between items-center"><p id="scan-mode-label" class="text-white font-medium text-sm bg-black/50 px-3 py-1 rounded-full" data-translate-key="scanInstructions">Arahkan ke Kartu Nama atau QR Code</p><button id="cancel-scan-btn" class="p-3 bg-black/50 rounded-full text-white hover:bg-black/80"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex justify-center items-center"><button id="capture-btn" class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-2xl ring-4 ring-white/30 transition-transform transform hover:scale-110" data-translate-key="scanBtn">SCAN</button></div></div><canvas id="canvas" class="hidden"></canvas></div>
            <div id="processing-screen" class="hidden screen justify-center items-center text-center p-8 flex-grow"><div class="loader mb-6"></div><h2 id="processing-title" class="text-2xl font-bold text-gray-900 dark:text-white animate-pulse" data-translate-key="processingTitle">AI Menganalisis Gambar...</h2><p class="text-gray-500 dark:text-gray-400 mt-2" data-translate-key="processingSubtitle">Mohon tunggu sebentar...</p></div>
            <div id="results-screen" class="hidden screen flex flex-col"><header class="p-6 flex justify-between items-center gap-4 border-b border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-900 dark:text-white flex-grow" data-translate-key="scanResultTitle">Hasil Scan</h2>
                <button id="lang-toggle-results" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">EN</button>
                <button id="back-to-home-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-sm uppercase tracking-wider transition-colors flex items-center justify-center w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 whitespace-nowrap"><i data-lucide="home" class="w-5 h-5 sm:hidden"></i><span class="hidden sm:inline" data-translate-key="mainMenuBtn">MENU UTAMA</span></button>
                <button id="theme-toggle-results" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                    <i data-lucide="sun" class="sm:hidden w-5 h-5"></i>
                    <i data-lucide="moon" class="sm:hidden w-5 h-5"></i>
                    <span class="hidden sm:inline" data-translate-key="themeBtnResults">TEMA</span>
                </button>
            </header><div class="flex-grow p-6 pt-4 overflow-y-auto"><p class="text-gray-600 dark:text-gray-400 mb-4"><span data-translate-key="totalContactsPart1">Total</span> <span id="results-contact-count" class="font-bold">0</span> <span data-translate-key="totalContactsPart2">kontak tersimpan di HP ini.</span></p><div id="results-list" class="space-y-3"></div></div><footer id="results-footer" class="p-6 border-t border-gray-200 dark:border-gray-700"><div id="export-buttons-container" class="grid grid-cols-2 gap-4"></div><button id="clear-all-btn" class="col-span-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg mt-4 flex items-center justify-center gap-2 uppercase" data-translate-key="deleteAllLocalDataBtn">HAPUS SEMUA DATA LOKAL</button></footer></div>
        </main>
        <footer class="text-center p-6 space-y-2 text-sm text-gray-500 dark:text-gray-400">
            <div class="flex justify-center items-center gap-x-4">
                <a href="about.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerAbout">Tentang</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="help.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerHelp">Bantuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="terms.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerTerms">Ketentuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="privacy.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerPrivacy">Privasi</a>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-600 pt-2" data-translate-key="footerCopyright">&copy; 2025 SCANNER PINTAR oleh Isparmo & M. Hasan</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="action-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-end sm:items-center sm:justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full sm:scale-95 sm:translate-y-0 opacity-0"><div class="flex justify-between items-start mb-4"><div id="action-modal-header"></div><button id="close-action-modal-btn" class="p-2 -mr-2 -mt-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button></div><div id="action-modal-body" class="text-sm text-gray-600 dark:text-gray-400 mb-6"></div><div id="action-modal-footer" class="grid grid-cols-2 gap-3"></div></div></div>
    <div id="show-session-qr-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6 text-center"><h3 class="text-xl font-bold mb-2" data-translate-key="sessionCreatedTitle">Sesi Dibuat!</h3><p class="text-gray-600 dark:text-gray-400 mb-4" data-translate-key="sessionCreatedSubtitle">Bagikan QR Code ini ke tim Anda untuk bergabung.</p><div id="qr-code-container"></div><button id="close-qr-modal-btn" class="modal-button w-full mt-6 bg-indigo-600 text-white hover:bg-indigo-700" data-translate-key="doneBtn">SELESAI</button></div></div>
    <div id="join-session-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6"><h3 class="text-xl font-bold mb-2" data-translate-key="joinCollabTitle">Gabung Sesi Kolaborasi</h3><p class="text-gray-600 dark:text-gray-400 mb-4"><span data-translate-key="joinCollabInvite">Anda diundang ke sesi</span> <strong id="join-session-name" class="text-indigo-500"></strong>. <span data-translate-key="joinCollabPrompt">Masukkan nama Anda:</span></p><input type="text" id="marketing-name-input" data-translate-key-placeholder="yourNameLabel" placeholder="Nama Anda" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"><div class="flex gap-4 mt-6"><button id="cancel-join-btn" class="modal-button flex-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300" data-translate-key="cancelBtn">BATAL</button><button id="confirm-join-btn" class="modal-button flex-1 bg-indigo-600 text-white hover:bg-indigo-700" data-translate-key="joinBtn">GABUNG</button></div></div></div>
    <div id="edit-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0"><h3 class="text-xl font-bold mb-4" data-translate-key="editContactTitle">Edit Kontak</h3><form id="edit-form" class="space-y-3"><input type="hidden" id="edit-contact-id"><div class="grid grid-cols-2 gap-3"><div><label for="edit-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="nameLabel">Nama</label><input type="text" id="edit-nama" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="positionLabel">Jabatan</label><input type="text" id="edit-jabatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="companyLabel">Perusahaan</label><input type="text" id="edit-perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jenis_perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="companyTypeLabel">Jenis Perusahaan</label><input type="text" id="edit-jenis_perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-telepon_kantor" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="officePhoneLabel">Telepon Kantor</label><input type="tel" id="edit-telepon_kantor" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-whatsapp" class="text-sm font-medium text-gray-600 dark:text-gray-400">WhatsApp</label><input type="tel" id="edit-whatsapp" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div><label for="edit-email" class="text-sm font-medium text-gray-600 dark:text-gray-400">Email</label><input type="email" id="edit-email" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><hr class="border-gray-200 dark:border-gray-600 !my-4"><div><label for="edit-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="eventLabel">Acara</label><input type="text" id="edit-acara" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="dateLabel">Tanggal</label><input type="date" id="edit-tanggal" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="notesLabel">Catatan</label><input type="text" id="edit-catatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div></form><div class="mt-6 flex items-center gap-3"><button id="delete-contact-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white flex-1 flex items-center justify-center gap-2" data-translate-key="deleteBtn">HAPUS</button><button id="cancel-edit-btn" class="modal-button bg-blue-600 hover:bg-blue-700 text-white flex-1" data-translate-key="cancelBtn">BATAL</button><button id="save-edit-btn" class="modal-button bg-green-600 hover:bg-green-700 text-white flex-1" data-translate-key="saveBtn">SIMPAN</button></div></div></div>
    <div id="confirm-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95 opacity-0"><h3 class="text-lg font-bold mb-2" data-translate-key="confirmActionTitle">Konfirmasi Tindakan</h3><p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6"></p><div class="flex justify-end items-center gap-3"><button id="cancel-confirm-btn" class="modal-button bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200" data-translate-key="cancelBtn">BATAL</button><button id="confirm-action-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white" data-translate-key="continueBtn">LANJUTKAN</button></div></div></div>
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 py-3 px-5 rounded-full shadow-lg opacity-0 transform translate-y-5 pointer-events-none"><p id="toast-message"></p></div>
    
    <!-- Log Viewer Elements -->
    <button id="log-icon" class="hidden p-2 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition-colors uppercase">Log</button>
    <div id="log-viewer-modal" class="modal-backdrop hidden fixed inset-0 bg-black/70 z-50 p-4 flex flex-col">
        <div class="modal-content w-full h-full max-w-4xl m-auto bg-gray-900 text-white rounded-lg shadow-2xl flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-bold">Frontend Error Log</h3>
                <button id="close-log-viewer-btn" class="p-1 hover:bg-gray-700 rounded-full text-gray-300 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </header>
            <div id="log-list" class="flex-grow p-4 overflow-y-auto font-mono text-sm space-y-2"></div>
            <footer class="p-3 border-t border-gray-700 flex-shrink-0 flex justify-end gap-4">
                <button id="copy-logs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-xs flex items-center gap-2 uppercase">Copy Logs</button>
                <button id="clear-logs-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md text-xs uppercase">Clear Logs</button>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }
            
            // ================== START: DUAL LANGUAGE FEATURE ==================
            let currentLang = 'id';

            const translations = {
                id: {
                    // Judul & Teks Umum
                    appTitle: "SCANNER PINTAR",
                    appSubtitle: "Scanner Kartu Nama & QR Code Berbasis AI",
                    mainMenuBtn: "MENU UTAMA",
                    themeBtn: "TEMA",
                    themeBtnResults: "TEMA",
                    profileBtn: "PROFIL",
                    cancelBtn: "BATAL",
                    doneBtn: "SELESAI",
                    joinBtn: "GABUNG",
                    deleteBtn: "HAPUS",
                    saveBtn: "SIMPAN",
                    continueBtn: "LANJUTKAN",
                    // Layar Awal
                    eventNameLabel: "Nama Acara",
                    eventNamePlaceholder: "Contoh: Pameran Konstruksi 2025",
                    dateLabel: "Tanggal",
                    notesLabel: "Catatan",
                    notesPlaceholder: "Opsional",
                    scanCardBtn: "SCAN KARTU NAMA",
                    uploadGalleryBtn: "UPLOAD DARI GALERI",
                    collabModeBtn: "MODE KOLABURASI TIM",
                    viewResultsBtn: "LIHAT HASIL SCAN",
                    // Mode Kolaborasi
                    collabMode: "Mode Kolaborasi:",
                    collabUser: "User:",
                    createCollabTitle: "Buat Sesi Kolaborasi Baru",
                    createCollabSubtitle: "Masukkan nama acara untuk membuat sesi yang dapat dibagikan.",
                    collabSessionNameLabel: "Nama Acara / Sesi",
                    collabSessionNamePlaceholder: "Contoh: Pameran Konstruksi 2025",
                    createQrBtn: "Buat QR Code",
                    joinCollabTitle: "Gabung Sesi Kolaborasi",
                    joinCollabInvite: "Anda diundang ke sesi",
                    joinCollabPrompt: "Masukkan nama Anda:",
                    sessionCreatedTitle: "Sesi Dibuat!",
                    sessionCreatedSubtitle: "Bagikan QR Code ini ke tim Anda untuk bergabung.",
                    confirmExitCollab: "Anda yakin ingin keluar dari sesi kolaborasi?",
                    // Profil
                    myProfileTitle: "Profil Saya",
                    yourNameLabel: "Nama Anda",
                    yourNamePlaceholder: "Cth: Isparmo",
                    yourPositionLabel: "Jabatan Anda",
                    yourPositionPlaceholder: "Cth: Marketing Manager",
                    yourCompanyLabel: "Nama Perusahaan Anda",
                    yourCompanyPlaceholder: "Cth: PT Multibangun Rekatama Patria",
                    companyDescLabel: "Deskripsi Singkat Perusahaan",
                    companyDescPlaceholder: "Cth: Spesialis Geosintetik sejak 1995...",
                    saveProfileBtn: "SIMPAN PROFIL",
                    // Scanner & Proses
                    scanInstructions: "Arahkan ke Kartu Nama atau QR Code",
                    scanBtn: "SCAN",
                    processingTitle: "AI Menganalisis Gambar...",
                    processingSubtitle: "Mohon tunggu sebentar...",
                    processingTakingPicture: "Mengambil gambar...",
                    processingFinalizing: "Memfinalisasi Data...",
                    processingQRCode: "Memproses QR Code...",
                    // Layar Hasil
                    scanResultTitle: "Hasil Scan",
                    totalContactsPart1: "Total",
                    totalContactsPart2: "kontak tersimpan di HP ini.",
                    noDataSaved: "Belum ada data tersimpan.",
                    deleteAllLocalDataBtn: "HAPUS SEMUA DATA LOKAL",
                    // Modal Edit Kontak
                    editContactTitle: "Edit Kontak",
                    nameLabel: "Nama",
                    positionLabel: "Jabatan",
                    companyLabel: "Perusahaan",
                    companyTypeLabel: "Jenis Perusahaan",
                    officePhoneLabel: "Telepon Kantor",
                    eventLabel: "Acara",
                    // Modal Aksi
                    actionSaveContact: "Simpan Kontak",
                    actionOpenWA: "Buka WA",
                    actionDraftWA: "Draf Pesan WA",
                    actionDraftEmail: "Draf Email",
                    // Modal Konfirmasi
                    confirmActionTitle: "Konfirmasi Tindakan",
                    confirmDeleteContact: "Apakah Anda yakin ingin menghapus kontak ini dari HP Anda? Tindakan ini tidak dapat dibatalkan.",
                    confirmClearAll: "Anda yakin ingin menghapus semua data LOKAL? Tindakan ini tidak akan menghapus data di Google Sheet.",
                    // Toast/Notifikasi
                    toastContactSaved: "Kontak baru berhasil disimpan!",
                    toastContactUpdated: "Kontak berhasil diperbarui!",
                    toastScanCancelled: "Scan dibatalkan.",
                    toastContactDeleted: "Kontak berhasil dihapus.",
                    toastAllDataDeleted: "Semua data lokal telah dihapus.",
                    toastProfileSaved: "Profil berhasil disimpan!",
                    toastWelcome: (name) => `Selamat datang, ${name}!`,
                    toastExitCollab: "Keluar dari mode kolaborasi.",
                    toastLogsCopied: "Log disalin ke clipboard!",
                    toastNoLogs: "Tidak ada log untuk disalin.",
                    toastCouldNotCopy: "Tidak dapat menyalin log.",
                    toastNoDataExport: "Tidak ada data untuk diekspor.",
                    toastDownloadingCSV: "File CSV sedang diunduh.",
                    toastDownloadingVCF: "File VCF sedang diunduh.",
                    toastDownloadingZIP: "File ZIP sedang diunduh.",
                    toastNoContactSave: "Tidak ada kontak untuk disimpan.",
                    toastGSheetSaveSuccess: (count) => `${count} kontak berhasil disimpan.`,
                    toastGSheetSaveError: (msg) => `Error: ${msg}`,
                    toastDataSentToGSheet: (name) => `Data terkirim ke Google Sheet: ${name}`,
                    toastFailSendGSheet: (name) => `Gagal kirim: ${name}. Data aman di lokal.`,
                    toastEmptyEventName: "Nama acara tidak boleh kosong.",
                    toastEmptyMarketingName: "Nama marketing tidak boleh kosong.",
                    toastProfileIncomplete: "Harap lengkapi profil Anda di menu Pengaturan terlebih dahulu.",
                    // PERBAIKAN: Menambahkan kunci terjemahan footer untuk Bahasa Indonesia
                    footerAbout: "Tentang",
                    footerHelp: "Bantuan",
                    footerTerms: "Ketentuan",
                    footerPrivacy: "Privasi",
                    footerCopyright: "&copy; 2025 SCANNER PINTAR oleh Isparmo & M. Hasan",
                    // Lain-lain
                    unnamedContact: "Tanpa Nama",
                    qrCodeContactName: "Kontak dari QR Code",
                    atCompany: "di",
                    phoneLabel: "HP",
                    eventLabelResult: "Acara",
                    notesLabelResult: "Catatan",
                    editBtn: "EDIT",
                    // Export
                    exportCSV: "SIMPAN .csv",
                    exportVCF: "SIMPAN .vcf",
                    exportZIP: "SIMPAN VCF .zip",
                    exportGSheet: "SIMPAN KE GOOGLE SHEET",
                    exportGSheetSaving: "Menyimpan...",
                    collabExportNote: "Data otomatis terkirim ke G-Sheet. Opsi ekspor di bawah hanya untuk data di HP ini."
                },
                en: {
                    // Common Titles & Text
                    appTitle: "SCANNER PINTAR",
                    appSubtitle: "AI-Powered Business Card & QR Code Scanner",
                    mainMenuBtn: "MAIN MENU",
                    themeBtn: "THEME",
                    themeBtnResults: "THEME",
                    profileBtn: "PROFILE",
                    cancelBtn: "CANCEL",
                    doneBtn: "DONE",
                    joinBtn: "JOIN",
                    deleteBtn: "DELETE",
                    saveBtn: "SAVE",
                    continueBtn: "CONTINUE",
                    // Initial Screen
                    eventNameLabel: "Event Name",
                    eventNamePlaceholder: "Example: Construction Expo 2025",
                    dateLabel: "Date",
                    notesLabel: "Notes",
                    notesPlaceholder: "Optional",
                    scanCardBtn: "SCAN BUSINESS CARD",
                    uploadGalleryBtn: "UPLOAD FROM GALLERY",
                    collabModeBtn: "TEAM COLLABORATION MODE",
                    viewResultsBtn: "VIEW SCAN RESULTS",
                    // Collaboration Mode
                    collabMode: "Collaboration Mode:",
                    collabUser: "User:",
                    createCollabTitle: "Create New Collaboration Session",
                    createCollabSubtitle: "Enter the event name to create a shareable session.",
                    collabSessionNameLabel: "Event / Session Name",
                    collabSessionNamePlaceholder: "Example: Construction Expo 2025",
                    createQrBtn: "Create QR Code",
                    joinCollabTitle: "Join Collaboration Session",
                    joinCollabInvite: "You are invited to the session",
                    joinCollabPrompt: "Enter your name:",
                    sessionCreatedTitle: "Session Created!",
                    sessionCreatedSubtitle: "Share this QR Code with your team to join.",
                    confirmExitCollab: "Are you sure you want to exit the collaboration session?",
                    // Profile
                    myProfileTitle: "My Profile",
                    yourNameLabel: "Your Name",
                    yourNamePlaceholder: "e.g., John Doe",
                    yourPositionLabel: "Your Position",
                    yourPositionPlaceholder: "e.g., Marketing Manager",
                    yourCompanyLabel: "Your Company Name",
                    yourCompanyPlaceholder: "e.g., Global Innovations Inc.",
                    companyDescLabel: "Short Company Description",
                    companyDescPlaceholder: "e.g., Geosynthetics specialist since 1995...",
                    saveProfileBtn: "SAVE PROFILE",
                    // Scanner & Processing
                    scanInstructions: "Point at a Business Card or QR Code",
                    scanBtn: "SCAN",
                    processingTitle: "AI is Analyzing Image...",
                    processingSubtitle: "Please wait a moment...",
                    processingTakingPicture: "Taking picture...",
                    processingFinalizing: "Finalizing Data...",
                    processingQRCode: "Processing QR Code...",
                    // Results Screen
                    scanResultTitle: "Scan Results",
                    totalContactsPart1: "Total of",
                    totalContactsPart2: "contacts saved on this phone.",
                    noDataSaved: "No saved data yet.",
                    deleteAllLocalDataBtn: "DELETE ALL LOCAL DATA",
                    // Edit Contact Modal
                    editContactTitle: "Edit Contact",
                    nameLabel: "Name",
                    positionLabel: "Position",
                    companyLabel: "Company",
                    companyTypeLabel: "Company Type",
                    officePhoneLabel: "Office Phone",
                    eventLabel: "Event",
                    // Action Modal
                    actionSaveContact: "Save Contact",
                    actionOpenWA: "Open WA",
                    actionDraftWA: "Draft WA",
                    actionDraftEmail: "Draft Email",
                    // Confirm Modal
                    confirmActionTitle: "Confirm Action",
                    confirmDeleteContact: "Are you sure you want to delete this contact from your phone? This action cannot be undone.",
                    confirmClearAll: "Are you sure you want to delete all LOCAL data? This will not delete data in Google Sheets.",
                    // Toasts/Notifications
                    toastContactSaved: "New contact saved successfully!",
                    toastContactUpdated: "Contact updated successfully!",
                    toastScanCancelled: "Scan cancelled.",
                    toastContactDeleted: "Contact deleted successfully.",
                    toastAllDataDeleted: "All local data has been deleted.",
                    toastProfileSaved: "Profile saved successfully!",
                    toastWelcome: (name) => `Welcome, ${name}!`,
                    toastExitCollab: "Exited collaboration mode.",
                    toastLogsCopied: "Logs copied to clipboard!",
                    toastNoLogs: "No logs to copy.",
                    toastCouldNotCopy: "Could not copy logs.",
                    toastNoDataExport: "No data to export.",
                    toastDownloadingCSV: "CSV file is downloading.",
                    toastDownloadingVCF: "VCF file is downloading.",
                    toastDownloadingZIP: "ZIP file is downloading.",
                    toastNoContactSave: "No contacts to save.",
                    toastGSheetSaveSuccess: (count) => `${count} contacts saved successfully.`,
                    toastGSheetSaveError: (msg) => `Error: ${msg}`,
                    toastDataSentToGSheet: (name) => `Data sent to Google Sheet: ${name}`,
                    toastFailSendGSheet: (name) => `Failed to send: ${name}. Data is safe locally.`,
                    toastEmptyEventName: "Event name cannot be empty.",
                    toastEmptyMarketingName: "Marketing name cannot be empty.",
                    toastProfileIncomplete: "Please complete your profile in the Settings menu first.",
                    // PERBAIKAN: Menambahkan kunci terjemahan footer yang hilang
                    footerAbout: "About",
                    footerHelp: "Help",
                    footerTerms: "Terms",
                    footerPrivacy: "Privacy",
                    footerCopyright: "&copy; 2025 SCANNER PINTAR by Isparmo & M. Hasan",
                    // Misc
                    unnamedContact: "Unnamed",
                    qrCodeContactName: "Contact from QR Code",
                    atCompany: "at",
                    phoneLabel: "Mobile",
                    eventLabelResult: "Event",
                    notesLabelResult: "Notes",
                    editBtn: "EDIT",
                    // Export
                    exportCSV: "SAVE .csv",
                    exportVCF: "SAVE .vcf",
                    exportZIP: "SAVE VCF .zip",
                    exportGSheet: "SAVE TO GOOGLE SHEET",
                    exportGSheetSaving: "Saving...",
                    collabExportNote: "Data is automatically sent to G-Sheet. The export options below are only for data on this phone."
                }
            };

            function getTranslation(key, ...args) {
                const translation = translations[currentLang][key];
                if (typeof translation === 'function') {
                    return translation(...args);
                }
                return translation || key;
            }

            function updateUI() {
                document.documentElement.lang = currentLang;

                // Update language toggle buttons
                const langToggles = document.querySelectorAll('#lang-toggle-initial, #lang-toggle-results');
                langToggles.forEach(toggle => {
                    toggle.textContent = currentLang === 'id' ? 'EN' : 'ID';
                });

                // Update elements with data-translate-key
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    el.innerHTML = getTranslation(key); // Use innerHTML to support potential icons
                });

                // Update elements with data-translate-key-placeholder
                document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-key-placeholder');
                    el.placeholder = getTranslation(key);
                });
                
                // Manually update any dynamic content if needed
                refreshResults(); 
            }

            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('scannerLang', lang);
                updateUI();
            }

            function toggleLanguage() {
                const newLang = currentLang === 'id' ? 'en' : 'id';
                setLanguage(newLang);
            }
            // ================== END: DUAL LANGUAGE FEATURE ==================

            const BACKEND_API_URL = 'https://scanner-api-328921559379.asia-southeast1.run.app';
            const GSHEET_BACKEND_URL = `${BACKEND_API_URL}/simpan-gsheet`;
            const EMAIL_GENERATOR_URL = `${BACKEND_API_URL}/generateFollowUpEmail`;
            const WA_GENERATOR_URL = `${BACKEND_API_URL}/generateFollowUpWa`; 
            
            let collaborationSession = { isActive: false, sessionId: null, sessionAcara: null, marketingName: null };
            let errorLogs = [];

            // --- Log Viewer Selectors ---
            const logIcon = document.getElementById('log-icon');
            const logViewerModal = document.getElementById('log-viewer-modal');
            const closeLogViewerBtn = document.getElementById('close-log-viewer-btn');
            const clearLogsBtn = document.getElementById('clear-logs-btn');
            const copyLogsBtn = document.getElementById('copy-logs-btn');
            const logList = document.getElementById('log-list');

            // --- Other Selectors ---
            const createSessionBtn = document.getElementById('create-session-btn');
            const cancelCreateSessionBtn = document.getElementById('cancel-create-session-btn');
            const generateSessionQRBtn = document.getElementById('generate-session-qr-btn');
            const collabSessionNameInput = document.getElementById('collab-session-name-input');
            const showSessionQRModal = document.getElementById('show-session-qr-modal');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const closeQrModalBtn = document.getElementById('close-qr-modal-btn');
            const joinSessionModal = document.getElementById('join-session-modal');
            const joinSessionName = document.getElementById('join-session-name');
            const marketingNameInput = document.getElementById('marketing-name-input');
            const cancelJoinBtn = document.getElementById('cancel-join-btn');
            const confirmJoinBtn = document.getElementById('confirm-join-btn');
            const collaborationModeIndicator = document.getElementById('collaboration-mode-indicator');
            const collabSessionName = document.getElementById('collab-session-name');
            const collabUserName = document.getElementById('collab-user-name');
            const exitCollabBtn = document.getElementById('exit-collab-btn');
            const { ...otherSelectors } = initializeSelectors();

            function initializeSelectors() {
                return {
                    screens: { initial: document.getElementById('initial-screen'), scanner: document.getElementById('scanner-screen'), processing: document.getElementById('processing-screen'), results: document.getElementById('results-screen'), createSession: document.getElementById('create-session-screen'), profile: document.getElementById('profile-screen') },
                    startScanBtn: document.getElementById('start-scan-btn'), uploadBtn: document.getElementById('upload-btn'), viewResultsBtn: document.getElementById('view-results-btn'), imageUploadInput: document.getElementById('image-upload-input'), captureBtn: document.getElementById('capture-btn'), cancelScanBtn: document.getElementById('cancel-scan-btn'), backToHomeBtn: document.getElementById('back-to-home-btn'), exportButtonsContainer: document.getElementById('export-buttons-container'), clearAllBtn: document.getElementById('clear-all-btn'), homeContactCount: document.getElementById('home-contact-count'), resultsContactCount: document.getElementById('results-contact-count'), resultsList: document.getElementById('results-list'), video: document.getElementById('video'), canvas: document.getElementById('canvas'), toast: document.getElementById('toast'), toastMessage: document.getElementById('toast-message'), processingTitle: document.getElementById('processing-title'), sessionAcaraInput: document.getElementById('session-acara'), sessionTanggalInput: document.getElementById('session-tanggal'), sessionCatatanInput: document.getElementById('session-catatan'), editModal: document.getElementById('edit-modal'), editModalContent: document.getElementById('edit-modal').querySelector('.modal-content'), cancelEditBtn: document.getElementById('cancel-edit-btn'), saveEditBtn: document.getElementById('save-edit-btn'), deleteContactBtn: document.getElementById('delete-contact-btn'), themeToggleInitial: document.getElementById('theme-toggle-initial'), themeToggleResults: document.getElementById('theme-toggle-results'), confirmModal: document.getElementById('confirm-modal'), confirmModalContent: document.getElementById('confirm-modal').querySelector('.modal-content'), confirmMessage: document.getElementById('confirm-message'), cancelConfirmBtn: document.getElementById('cancel-confirm-btn'), confirmActionBtn: document.getElementById('confirm-action-btn'),
                    profileSettingsBtn: document.getElementById('profile-settings-btn'), backToHomeFromProfile: document.getElementById('back-to-home-from-profile'), saveProfileBtn: document.getElementById('save-profile-btn'),
                    actionModal: document.getElementById('action-modal'), actionModalContent: document.getElementById('action-modal').querySelector('.modal-content'), closeActionModalBtn: document.getElementById('close-action-modal-btn'), actionModalHeader: document.getElementById('action-modal-header'), actionModalBody: document.getElementById('action-modal-body'), actionModalFooter: document.getElementById('action-modal-footer'),
                    langToggleInitial: document.getElementById('lang-toggle-initial'),
                    langToggleResults: document.getElementById('lang-toggle-results')
                };
            }
            
            let stream, qrScanInterval, confirmCallback = null;

            // --- Phone Number Formatting ---
            function formatKantor(phone) {
                if (!phone) return '';
                let digits = phone.replace(/\D/g, '');
                if (digits.startsWith('62')) {
                    digits = '0' + digits.substring(2);
                }
                return digits;
            }

            function formatWA(phone) {
                if (!phone) return '';
                let digits = phone.replace(/\D/g, '');
                if (digits.startsWith('0')) {
                    digits = '62' + digits.substring(1);
                }
                return digits;
            }

             // --- Log Viewer Logic (IMPROVED) ---
            function logError(message, errorObject = null) {
                console.error(message, errorObject);
                const timestamp = new Date().toLocaleTimeString();
                
                let details = '';
                if (errorObject) {
                    details = `Error Type: ${errorObject.name}\nMessage: ${errorObject.message}\n`;
                    if(errorObject.stack) {
                        details += `Stack Trace:\n${errorObject.stack}`;
                    }
                }

                errorLogs.push({ timestamp, message, details });
                renderLogs();
            }

            function renderLogs() {
                logList.innerHTML = '';
                if (errorLogs.length === 0) {
                    logList.innerHTML = '<p class="text-gray-500">No errors logged yet.</p>';
                } else {
                    errorLogs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry p-2';
                        const sanitizedDetails = log.details.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        logEntry.innerHTML = `
                            <p class="text-gray-400 text-xs">${log.timestamp}</p>
                            <p class="text-red-400 font-semibold">${log.message}</p>
                            <pre class="text-gray-300 text-xs whitespace-pre-wrap">${sanitizedDetails}</pre>
                        `;
                        logList.appendChild(logEntry);
                    });
                }
            }
            
            const dbLogic = {
                db: null,
                init: function() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('SmartScannerDB', 2);
                        request.onerror = (event) => { logError("Database error", event.target.error); reject("Database error"); };
                        request.onsuccess = (event) => { this.db = event.target.result; resolve(); };
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('contacts')) { 
                                db.createObjectStore('contacts', { keyPath: 'id', autoIncrement: true });
                            }
                        };
                    });
                },
                addContact: function(contact) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.add(contact); request.onsuccess = resolve; request.onerror = (e) => { logError("Add contact DB error", e.target.error); reject(e.target.error); }; }); },
                getContact: function(id) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readonly'); const store = transaction.objectStore('contacts'); const request = store.get(id); request.onsuccess = (event) => resolve(event.target.result); request.onerror = (e) => { logError("Get contact DB error", e.target.error); reject(e.target.error); }; }); },
                updateContact: function(contact) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.put(contact); request.onsuccess = resolve; request.onerror = (e) => { logError("Update contact DB error", e.target.error); reject(e.target.error); }; }); },
                deleteContact: function(id) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.delete(id); request.onsuccess = resolve; request.onerror = (e) => { logError("Delete contact DB error", e.target.error); reject(e.target.error); }; }); },
                getAllContacts: function() { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readonly'); const store = transaction.objectStore('contacts'); const request = store.getAll(); request.onsuccess = (event) => resolve(event.target.result); request.onerror = (e) => { logError("Get all contacts DB error", e.target.error); reject(e.target.error); }; }); },
                clearAllContacts: function() { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.clear(); request.onsuccess = resolve; request.onerror = (e) => { logError("Clear contacts DB error", e.target.error); reject(e.target.error); }; }); }
            };
            
            function showToast(message, duration = 3000) {
                otherSelectors.toastMessage.textContent = message;
                otherSelectors.toast.classList.remove('opacity-0', 'translate-y-5');
                setTimeout(() => { otherSelectors.toast.classList.add('opacity-0', 'translate-y-5'); }, duration);
            }

            function showScreen(screenName) {
                Object.values(otherSelectors.screens).forEach(screen => { if (screen) screen.classList.add('hidden'); });
                if (otherSelectors.screens[screenName]) { otherSelectors.screens[screenName].classList.remove('hidden'); }
            }

            function applyTheme(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                [otherSelectors.themeToggleInitial, otherSelectors.themeToggleResults].forEach(toggle => {
                    if (!toggle) return;
                    const sunIcon = toggle.querySelector('[data-lucide="sun"]');
                    const moonIcon = toggle.querySelector('[data-lucide="moon"]');
                    if (sunIcon && moonIcon) {
                        if (isDark) {
                            moonIcon.classList.add('hidden');
                            sunIcon.classList.remove('hidden');
                        } else {
                            sunIcon.classList.add('hidden');
                            moonIcon.classList.remove('hidden');
                        }
                    }
                });
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            function toggleTheme() {
                applyTheme(!document.documentElement.classList.contains('dark'));
            }

            function showConfirmModal(message, onConfirm) {
                otherSelectors.confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                otherSelectors.confirmModal.classList.remove('hidden');
                setTimeout(() => {
                    otherSelectors.confirmModal.classList.remove('opacity-0');
                    otherSelectors.confirmModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideConfirmModal() {
                otherSelectors.confirmModal.classList.add('opacity-0');
                otherSelectors.confirmModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    otherSelectors.confirmModal.classList.add('hidden');
                    confirmCallback = null;
                }, 300);
            }

            function scanQRCode() {
                if (!otherSelectors.video.srcObject || otherSelectors.video.readyState !== otherSelectors.video.HAVE_ENOUGH_DATA) return;
                const context = otherSelectors.canvas.getContext('2d');
                otherSelectors.canvas.width = otherSelectors.video.videoWidth;
                otherSelectors.canvas.height = otherSelectors.video.videoHeight;
                context.drawImage(otherSelectors.video, 0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                const imageData = context.getImageData(0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) { 
                    stopCamera(); 
                    if (code.data.includes('?sesi=') && code.data.includes('&acara=')) {
                        window.location.href = code.data;
                    } else {
                        processQRCode(code.data); 
                    }
                }
            }

            async function startCamera() {
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); }
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    otherSelectors.video.srcObject = stream;
                    otherSelectors.video.onloadedmetadata = () => {
                        otherSelectors.canvas.width = otherSelectors.video.videoWidth;
                        otherSelectors.canvas.height = otherSelectors.video.videoHeight;
                        if(qrScanInterval) clearInterval(qrScanInterval);
                        qrScanInterval = setInterval(scanQRCode, 500);
                    };
                    showScreen('scanner');
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Cannot access camera. Please ensure you have granted permission.");
                    showScreen('initial');
                }
            }
            
            function stopCamera() {
                if (qrScanInterval) clearInterval(qrScanInterval);
                qrScanInterval = null;
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
            }

            function resizeImage(base64Str, maxWidth = 1024, maxHeight = 1024) {
                return new Promise((resolve) => {
                    let img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        let canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                        else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width; canvas.height = height;
                        let ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    };
                });
            }
            
            async function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const finalImageDataUrl = await resizeImage(e.target.result);
                    await processImageWithAI(finalImageDataUrl);
                };
                reader.readAsDataURL(file);
                otherSelectors.imageUploadInput.value = '';
            }

            async function captureAndProcess() {
                showScreen('processing');
                otherSelectors.processingTitle.textContent = getTranslation('processingTakingPicture');

                const context = otherSelectors.canvas.getContext('2d');
                otherSelectors.canvas.width = otherSelectors.video.videoWidth;
                otherSelectors.canvas.height = otherSelectors.video.videoHeight;

                context.drawImage(otherSelectors.video, 0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                
                stopCamera();
                
                const imageDataUrl = otherSelectors.canvas.toDataURL('image/jpeg', 0.9);
                const finalImageDataUrl = await resizeImage(imageDataUrl);
                await processImageWithAI(finalImageDataUrl);
            }
            
            async function processImageWithAI(imageDataUrl) {
                try {
                    otherSelectors.processingTitle.textContent = getTranslation('processingTitle');
                    const extractResponse = await fetch(`${BACKEND_API_URL}/processBusinessCard`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageDataUrl })
                    });
                    if (!extractResponse.ok) { const errorText = await extractResponse.text(); throw new Error(`Backend Error: ${extractResponse.status}. Detail: ${errorText}`); }
                    
                    const extractResult = await extractResponse.json();
                    const jsonString = extractResult.data;
                    if (!jsonString) { throw new Error("Invalid response from Backend."); }
                    
                    const extractedData = JSON.parse(jsonString);

                    otherSelectors.processingTitle.textContent = getTranslation('processingFinalizing');
                    const refineResponse = await fetch(`${BACKEND_API_URL}/refineAndTranslate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ extractedData })
                    });
                    if (!refineResponse.ok) { const errorText = await refineResponse.text(); throw new Error(`Refinement Error: ${refineResponse.status}. Detail: ${errorText}`); }

                    const refineResult = await refineResponse.json();
                    const refinedJsonString = refineResult.data;
                    if (!refinedJsonString) { throw new Error("Invalid response from finalization process."); }

                    const finalData = JSON.parse(refinedJsonString);

                    finalData.telepon_kantor = formatKantor(finalData.telepon_kantor);
                    finalData.whatsapp = formatWA(finalData.whatsapp);
                    
                    await openEditModalForNewContact(finalData);

                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        const errorMessage = "Failed to connect to the scan server. This might be due to a browser extension (Ad-Blocker) or a network issue. Try Incognito mode.";
                        logError("Processing Error (Fetch Error):", error);
                        showToast(errorMessage, 5000);
                    } else {
                        logError("Processing Error (General Error):", error);
                        showToast(`Failed to process image: ${error.message}`);
                    }
                    showScreen('initial');
                }
            }
            
            async function processQRCode(data) {
                otherSelectors.processingTitle.textContent = getTranslation('processingQRCode');
                showScreen('processing');
                try {
                    const contact = data.startsWith('BEGIN:VCARD') ? parseVCard(data) : { nama: getTranslation('qrCodeContactName'), catatan: data };
                    contact.telepon_kantor = formatKantor(contact.telepon_kantor);
                    contact.whatsapp = formatWA(contact.whatsapp);
                    await openEditModalForNewContact(contact);
                } catch(error) {
                    logError("QR Processing Error:", error);
                    showToast(`Failed to process QR Code: ${error.message}`);
                    showScreen('initial');
                }
            }

            function parseVCard(vcardString) {
                const contact = {};
                const lines = vcardString.split(/[\n\r]+/);
                lines.forEach(line => {
                    if (!line.includes(':')) return;
                    let [key, ...valueParts] = line.split(':');
                    let value = valueParts.join(':').trim();
                    const keyParts = key.split(';');
                    const mainKey = keyParts[0].toUpperCase();
                    const params = {};
                    if (keyParts.length > 1) {
                        keyParts.slice(1).forEach(p => {
                            const [paramKey, paramValue] = p.split('=');
                            if (paramKey && paramValue) {
                                const pKey = paramKey.toUpperCase();
                                if (pKey === 'TYPE') {
                                    params[pKey] = (params[pKey] || []).concat(paramValue.split(','));
                                } else {
                                    params[pKey] = paramValue;
                                }
                            }
                        });
                    }
                    if (mainKey === 'FN' && !contact.nama) contact.nama = value;
                    else if (mainKey === 'N' && !contact.nama) { const nameParts = value.split(';'); contact.nama = `${nameParts[1] || ''} ${nameParts[0] || ''}`.trim(); }
                    else if (mainKey === 'TITLE' && !contact.jabatan) contact.jabatan = value;
                    else if (mainKey === 'ORG' && !contact.perusahaan) contact.perusahaan = value;
                    else if (mainKey === 'EMAIL' && !contact.email) contact.email = value;
                    else if (mainKey === 'CATEGORIES' && !contact.jenis_perusahaan) { contact.jenis_perusahaan = value.split(',').map(s => s.trim()).join(', '); }
                    else if (mainKey === 'TEL') {
                        const types = params.TYPE || [];
                        if (types.includes('WORK') && !contact.telepon_kantor) { contact.telepon_kantor = value; } 
                        else if (types.includes('CELL') && !contact.whatsapp) { contact.whatsapp = value; } 
                        else if (!contact.telepon_kantor && !contact.whatsapp) { contact.whatsapp = value; }
                    } 
                    else if (mainKey === 'X-WHATSAPP' && !contact.whatsapp) { contact.whatsapp = value; }
                });
                return contact;
            }

            async function refreshResults() {
                // PERBAIKAN: Tambahkan penjaga untuk mencegah eksekusi jika DB belum siap.
                if (!dbLogic.db) return;
                const contacts = await dbLogic.getAllContacts();
                const count = contacts.length;
                otherSelectors.homeContactCount.textContent = count;
                otherSelectors.resultsContactCount.textContent = count;
                otherSelectors.resultsList.innerHTML = '';
                if (count === 0) {
                    otherSelectors.resultsList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">${getTranslation('noDataSaved')}</p>`;
                } else {
                    contacts.reverse().forEach(contact => {
                        const card = document.createElement('div');
                        card.className = 'contact-card bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 rounded-xl';
                        card.dataset.id = contact.id;
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-3"> <p class="font-bold text-lg text-gray-900 dark:text-white">${contact.nama || getTranslation('unnamedContact')}</p> ${contact.jenis_perusahaan ? `<span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-100 dark:bg-indigo-900/50 px-2 py-0.5 rounded-full">${contact.jenis_perusahaan}</span>` : ''} </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${contact.jabatan || ''} ${getTranslation('atCompany')} ${contact.perusahaan || ''}</p>
                                </div>
                                <button class="edit-btn p-2 text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 flex-shrink-0" data-id="${contact.id}">${getTranslation('editBtn')}</button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400"> ${contact.whatsapp ? `<span>${getTranslation('phoneLabel')}: ${contact.whatsapp}</span>` : ''} ${contact.email ? `<span class="ml-2">Email: ${contact.email}</span>` : ''} </div>
                            ${(contact.acara || contact.catatan) ? `<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400"> ${contact.acara ? `<p><strong>${getTranslation('eventLabelResult')}:</strong> ${contact.acara} (${contact.tanggal || ''})</p>` : ''} ${contact.catatan ? `<p><strong>${getTranslation('notesLabelResult')}:</strong> ${contact.catatan}</p>` : ''} </div>` : ''}`;
                        otherSelectors.resultsList.appendChild(card);
                    });
                     document.querySelectorAll('.contact-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            if (e.target.closest('.edit-btn')) {
                                openEditModal(parseInt(e.currentTarget.dataset.id));
                            } else {
                                openActionModal(parseInt(e.currentTarget.dataset.id));
                            }
                        });
                    });
                }
                updateExportButtons(contacts);
                lucide.createIcons();
            }

            async function openActionModal(id) {
                const contact = await dbLogic.getContact(id);
                if (!contact) return;

                otherSelectors.actionModalHeader.innerHTML = `<h3 class="text-xl font-bold text-gray-900 dark:text-white">${contact.nama || getTranslation('unnamedContact')}</h3>`;
                otherSelectors.actionModalBody.innerHTML = `<p>${contact.jabatan || ''} ${getTranslation('atCompany')} ${contact.perusahaan || ''}</p><p class="mt-1">${getTranslation('eventLabel')}: ${contact.acara || '-'}</p>`;
                
                let footerHTML = '';
                footerHTML += `<button id="action-save-vcf" class="modal-button bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center gap-2 uppercase">${getTranslation('actionSaveContact')}</button>`;
                
                if (contact.whatsapp) {
                    footerHTML += `<button id="action-whatsapp" data-wa="${contact.whatsapp}" class="modal-button bg-green-500 text-white hover:bg-green-600 flex items-center justify-center gap-2 uppercase">${getTranslation('actionOpenWA')}</button>`;
                    footerHTML += `<button id="action-whatsapp-ai" class="modal-button bg-teal-500 text-white hover:bg-teal-600 flex items-center justify-center gap-2 uppercase">${getTranslation('actionDraftWA')}</button>`;
                }

                if (contact.email) {
                    footerHTML += `<button id="action-email" class="modal-button bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center gap-2 uppercase">${getTranslation('actionDraftEmail')}</button>`;
                }
                
                otherSelectors.actionModalFooter.innerHTML = footerHTML;
                lucide.createIcons();
                
                document.getElementById('action-save-vcf').addEventListener('click', () => exportVCF(contact));
                
                if(contact.whatsapp) {
                    document.getElementById('action-whatsapp').addEventListener('click', (e) => {
                         const waNumber = e.currentTarget.dataset.wa;
                         const url = `https://wa.me/${waNumber}`;
                         window.open(url, '_blank');
                    });
                    document.getElementById('action-whatsapp-ai').addEventListener('click', () => generateAndOpenWa(contact));
                }

                if(contact.email && document.getElementById('action-email')) {
                    document.getElementById('action-email').addEventListener('click', () => generateAndOpenEmail(contact));
                }

                otherSelectors.actionModal.classList.remove('hidden');
                setTimeout(() => { 
                    otherSelectors.actionModal.classList.remove('opacity-0');
                    otherSelectors.actionModalContent.classList.remove('translate-y-full', 'sm:scale-95', 'sm:translate-y-0', 'opacity-0'); 
                }, 10);
            }
            
            async function generateAndOpenEmail(contact) {
                const profile = JSON.parse(localStorage.getItem('userProfile'));
                if (!profile || !profile.nama || !profile.jabatan || !profile.perusahaan) {
                    showToast(getTranslation('toastProfileIncomplete')); return;
                }

                const emailBtn = document.getElementById('action-email');
                emailBtn.disabled = true;
                emailBtn.innerHTML = `<div class="loader btn-loader"></div>`;
                
                try {
                    const response = await fetch(EMAIL_GENERATOR_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact, profile, lang: currentLang })
                    });
                    
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to create email draft. Status: ${response.status}. Detail: ${errorText}`); }
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        const emailData = JSON.parse(result.data);
                        const subject = encodeURIComponent(emailData.subject || `Introduction from ${profile.perusahaan}`);
                        const body = encodeURIComponent(emailData.body || '');
                        window.location.href = `mailto:${contact.email}?subject=${subject}&body=${body}`;
                    } else { throw new Error('Invalid AI response.'); }
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        const errorMessage = "Failed to connect to server. This might be due to a browser extension (Ad-Blocker) or network issue.";
                        logError("Failed to generate email (Fetch Error):", error);
                        showToast(errorMessage, 5000);
                    } else {
                        logError("Failed to generate email (General Error):", error);
                        showToast(error.message);
                    }
                } finally {
                    emailBtn.disabled = false;
                    emailBtn.innerHTML = getTranslation('actionDraftEmail');
                }
            }

            async function generateAndOpenWa(contact) {
                const profile = JSON.parse(localStorage.getItem('userProfile'));
                if (!profile || !profile.nama) {
                    showToast(getTranslation('toastProfileIncomplete')); return;
                }

                const waAiBtn = document.getElementById('action-whatsapp-ai');
                waAiBtn.disabled = true;
                waAiBtn.innerHTML = `<div class="loader btn-loader"></div>`;
                
                try {
                    const response = await fetch(WA_GENERATOR_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact, profile, lang: currentLang })
                    });
                    
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to create WA draft. Status: ${response.status}. Detail: ${errorText}`); }
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        const message = encodeURIComponent(result.data);
                        const waNumber = formatWA(contact.whatsapp);
                        const url = `https://wa.me/${waNumber}?text=${message}`;
                        window.open(url, '_blank');
                        closeActionModal();
                    } else { throw new Error('Invalid AI response for WA.'); }
                } catch (error) {
                    logError("Failed to generate WA message:", error);
                    showToast(error.message);
                } finally {
                    waAiBtn.disabled = false;
                    waAiBtn.innerHTML = getTranslation('actionDraftWA');
                }
            }

            function closeActionModal() {
                 otherSelectors.actionModal.classList.add('opacity-0');
                 otherSelectors.actionModalContent.classList.add('translate-y-full', 'sm:scale-95', 'sm:translate-y-0', 'opacity-0');
                setTimeout(() => { otherSelectors.actionModal.classList.add('hidden'); }, 300);
            }

            async function openEditModalForNewContact(contact) {
                document.querySelector('.app-container').classList.add('hidden');
                
                document.getElementById('edit-contact-id').value = ''; 
                document.getElementById('edit-nama').value = contact.nama || '';
                document.getElementById('edit-jabatan').value = contact.jabatan || '';
                document.getElementById('edit-perusahaan').value = contact.perusahaan || '';
                document.getElementById('edit-jenis_perusahaan').value = contact.jenis_perusahaan || '';
                document.getElementById('edit-telepon_kantor').value = contact.telepon_kantor || '';
                document.getElementById('edit-whatsapp').value = contact.whatsapp || '';
                document.getElementById('edit-email').value = contact.email || '';
                
                document.getElementById('edit-acara').value = otherSelectors.sessionAcaraInput.value;
                document.getElementById('edit-tanggal').value = otherSelectors.sessionTanggalInput.value;
                document.getElementById('edit-catatan').value = contact.catatan || otherSelectors.sessionCatatanInput.value;
                
                otherSelectors.editModal.classList.remove('hidden');
                setTimeout(() => { 
                    otherSelectors.editModal.classList.remove('opacity-0'); 
                    otherSelectors.editModalContent.classList.remove('scale-95', 'opacity-0'); 
                }, 10);
            }

            async function openEditModal(id) {
                const contact = await dbLogic.getContact(id);
                if (!contact) return;
                
                document.querySelector('.app-container').classList.add('hidden');
                
                document.getElementById('edit-contact-id').value = contact.id;
                document.getElementById('edit-nama').value = contact.nama || '';
                document.getElementById('edit-jabatan').value = contact.jabatan || '';
                document.getElementById('edit-perusahaan').value = contact.perusahaan || '';
                document.getElementById('edit-jenis_perusahaan').value = contact.jenis_perusahaan || '';
                document.getElementById('edit-telepon_kantor').value = contact.telepon_kantor || '';
                document.getElementById('edit-whatsapp').value = contact.whatsapp || '';
                document.getElementById('edit-email').value = contact.email || '';
                document.getElementById('edit-acara').value = contact.acara || '';
                document.getElementById('edit-tanggal').value = contact.tanggal || '';
                document.getElementById('edit-catatan').value = contact.catatan || '';
                otherSelectors.editModal.classList.remove('hidden');
                setTimeout(() => { otherSelectors.editModal.classList.remove('opacity-0'); otherSelectors.editModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            function closeEditModal() {
                otherSelectors.editModal.classList.add('opacity-0');
                otherSelectors.editModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    otherSelectors.editModal.classList.add('hidden');
                    document.querySelector('.app-container').classList.remove('hidden');
                    showScreen('initial'); 
                }, 300);
            }

            async function saveContactChanges() {
                const idValue = document.getElementById('edit-contact-id').value;
                const isNewContact = !idValue;

                const contactData = {
                    nama: document.getElementById('edit-nama').value,
                    jabatan: document.getElementById('edit-jabatan').value,
                    perusahaan: document.getElementById('edit-perusahaan').value,
                    jenis_perusahaan: document.getElementById('edit-jenis_perusahaan').value,
                    telepon_kantor: formatKantor(document.getElementById('edit-telepon_kantor').value),
                    whatsapp: formatWA(document.getElementById('edit-whatsapp').value),
                    email: document.getElementById('edit-email').value,
                    acara: document.getElementById('edit-acara').value,
                    tanggal: document.getElementById('edit-tanggal').value,
                    catatan: document.getElementById('edit-catatan').value,
                };

                if (isNewContact) {
                    await dbLogic.addContact(contactData);
                    showToast(getTranslation('toastContactSaved'));
                } else {
                    contactData.id = parseInt(idValue);
                    await dbLogic.updateContact(contactData);
                    showToast(getTranslation('toastContactUpdated'));
                }

                if (collaborationSession.isActive) {
                    showToast('Sending data to Google Sheet...');
                    await sendCollaborativeData({ ...contactData, marketingName: collaborationSession.marketingName });
                }
                
                await refreshResults();
                showScreen('results');
                closeEditModal();
            }

            async function handleDeleteContact() {
                const idValue = document.getElementById('edit-contact-id').value;
                const isNewContact = !idValue;

                if (isNewContact) {
                    closeEditModal(); 
                    showToast(getTranslation('toastScanCancelled'));
                    return;
                }
                
                const id = parseInt(idValue);
                showConfirmModal(
                    getTranslation('confirmDeleteContact'),
                    async () => {
                        try {
                            await dbLogic.deleteContact(id);
                            showToast(getTranslation('toastContactDeleted'));
                            closeEditModal();
                            await refreshResults();
                        } catch (error) { 
                            logError("Failed to delete contact:", error); 
                            showToast("Failed to delete contact."); 
                        }
                    }
                );
            }
            
            function setupCollaborationModeUI() {
                collaborationSession.isActive = true;
                document.getElementById('session-form-container').classList.add('opacity-50', 'pointer-events-none');
                createSessionBtn.classList.add('hidden');
                
                collaborationModeIndicator.classList.remove('hidden');
                collabSessionName.textContent = collaborationSession.sessionAcara;
                collabUserName.textContent = collaborationSession.marketingName;

                otherSelectors.sessionAcaraInput.value = collaborationSession.sessionAcara;
                otherSelectors.sessionTanggalInput.value = new Date().toISOString().slice(0, 10);
            }

            function exitCollaborationMode() {
                showConfirmModal(getTranslation('confirmExitCollab'), () => {
                    localStorage.removeItem('collaborationSession');
                    collaborationSession = { isActive: false, sessionId: null, sessionAcara: null, marketingName: null };
                    
                    const url = new URL(window.location);
                    url.searchParams.delete('sesi');
                    url.searchParams.delete('acara');
                    window.history.pushState({}, '', url);

                    collaborationModeIndicator.classList.add('hidden');
                    document.getElementById('session-form-container').classList.remove('opacity-50', 'pointer-events-none');
                    createSessionBtn.classList.remove('hidden');
                    showToast(getTranslation('toastExitCollab'));
                });
            }
            
            async function sendCollaborativeData(contact) {
                try {
                    const response = await fetch(GSHEET_BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact: contact })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.error || 'Failed to send data.');
                    showToast(getTranslation('toastDataSentToGSheet', contact.nama));
                } catch (error) {
                    logError("Failed to send collaborative data", error);
                    showToast(getTranslation('toastFailSendGSheet', contact.nama));
                }
            }
            
            function updateExportButtons(contacts) {
                let buttonsHTML = '';
                if (collaborationSession.isActive) {
                    buttonsHTML = `
                        <p class="col-span-2 text-xs text-center text-gray-500 dark:text-gray-400">${getTranslation('collabExportNote')}</p>
                        <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportCSV')}</button>
                        <button id="export-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportZIP')}</button>
                    `;
                } else {
                    if (contacts.length === 1) {
                        buttonsHTML = `
                            <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportCSV')}</button>
                            <button id="export-vcf-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportVCF')}</button>
                        `;
                    } else if (contacts.length > 1) {
                         buttonsHTML = `
                            <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportCSV')}</button>
                            <button id="export-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base">${getTranslation('exportZIP')}</button>
                        `;
                    }
                    if (contacts.length > 0) {
                        buttonsHTML += `
                            <button id="export-gsheet-btn" class="col-span-2 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base mt-2">
                                ${getTranslation('exportGSheet')}
                            </button>
                        `;
                    }
                }
                otherSelectors.exportButtonsContainer.innerHTML = buttonsHTML;
                
                if (contacts.length > 0) {
                    if (document.getElementById('export-csv-btn')) document.getElementById('export-csv-btn').addEventListener('click', () => exportCSV(contacts));
                    if (document.getElementById('export-vcf-btn')) document.getElementById('export-vcf-btn').addEventListener('click', () => exportVCF(contacts[0]));
                    if (document.getElementById('export-zip-btn')) document.getElementById('export-zip-btn').addEventListener('click', () => exportZIP(contacts));
                    if (document.getElementById('export-gsheet-btn')) {
                         const gsheetBtn = document.getElementById('export-gsheet-btn');
                         gsheetBtn.addEventListener('click', () => saveAllToGoogleSheet(gsheetBtn));
                    }
                }
            }

            async function saveAllToGoogleSheet(button) {
                 const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<div class="loader btn-loader"></div><span class="ml-2">${getTranslation('exportGSheetSaving')}</span>`;
                try {
                    const contacts = await dbLogic.getAllContacts();
                    if (contacts.length === 0) { showToast(getTranslation('toastNoContactSave')); return; }
                    const response = await fetch(GSHEET_BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contacts: contacts })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.error || 'Failed to save data.');
                    showToast(result.message || getTranslation('toastGSheetSaveSuccess', contacts.length));
                } catch (error) {
                    logError("Error saving all to Google Sheet", error);
                    showToast(getTranslation('toastGSheetSaveError', error.message));
                } finally {
                    button.disabled = false;
                    button.innerHTML = getTranslation('exportGSheet');
                }
            }

            function exportCSV(contacts) {
                if (contacts.length === 0) { showToast(getTranslation('toastNoDataExport')); return; }
                const headers = ['Name', 'Position', 'Company', 'Company Type', 'Office Phone', 'WhatsApp', 'Email', 'Event', 'Date', 'Notes'];
                let csvContent = headers.join(',') + '\n';
                const escapeCSV = (field) => `"${String(field || '').replace(/"/g, '""')}"`;
                contacts.forEach(c => {
                    const row = [c.nama, c.jabatan, c.perusahaan, c.jenis_perusahaan, c.telepon_kantor, c.whatsapp, c.email, c.acara, c.tanggal, c.catatan];
                    csvContent += row.map(escapeCSV).join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `business_card_contacts_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                showToast(getTranslation('toastDownloadingCSV'));
            }

            function createVCardString(contact) {
                let vCard = `BEGIN:VCARD\nVERSION:3.0\nFN:${contact.nama || ''}\nORG:${contact.perusahaan || ''}\nTITLE:${contact.jabatan || ''}\n`;
                if(contact.jenis_perusahaan) vCard += `CATEGORIES:${contact.jenis_perusahaan}\n`;
                if (contact.telepon_kantor) vCard += `TEL;TYPE=WORK,VOICE:${contact.telepon_kantor}\n`;
                if (contact.whatsapp) vCard += `TEL;TYPE=CELL,VOICE:${contact.whatsapp}\n`;
                if (contact.email) vCard += `EMAIL:${contact.email}\n`;
                let note = [];
                if (contact.acara) note.push(`${getTranslation('eventLabel')}: ${contact.acara} (${contact.tanggal || ''})`);
                if (contact.catatan) note.push(`${getTranslation('notesLabel')}: ${contact.catatan}`);
                if (note.length > 0) vCard += `NOTE:${note.join(' | ')}\n`;
                vCard += `END:VCARD`;
                return vCard;
            }

            function exportVCF(contact) {
                const vCardString = createVCardString(contact);
                const blob = new Blob([vCardString], { type: 'text/vcard;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                const filename = (contact.nama || `contact`).replace(/\s+/g, '_').toLowerCase();
                link.download = `${filename}.vcf`;
                link.click();
                showToast(getTranslation('toastDownloadingVCF'));
            }

            function exportZIP(contacts) {
                if (contacts.length === 0) { showToast(getTranslation('toastNoDataExport')); return; }
                const zip = new JSZip();
                contacts.forEach((c, i) => {
                    const vCardString = createVCardString(c);
                    const filename = (c.nama || `contact_${i + 1}`).replace(/\s+/g, '_').toLowerCase() + '.vcf';
                    zip.file(filename, vCardString);
                });
                zip.generateAsync({ type: "blob" }).then(content => {
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(content);
                    link.download = `vcf_contacts_${new Date().toISOString().slice(0,10)}.zip`;
                    link.click();
                    showToast(getTranslation('toastDownloadingZIP'));
                });
            }
            
            function loadAndDisplayProfile() {
                const profile = JSON.parse(localStorage.getItem('userProfile')) || {};
                document.getElementById('profile-nama').value = profile.nama || '';
                document.getElementById('profile-jabatan').value = profile.jabatan || '';
                document.getElementById('profile-perusahaan').value = profile.perusahaan || '';
                document.getElementById('profile-deskripsi').value = profile.deskripsi || '';
            }

            async function initializeApp() {
                lucide.createIcons();
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedTheme ? savedTheme === 'dark' : prefersDark);
                otherSelectors.sessionAcaraInput.value = localStorage.getItem('sessionAcara') || '';
                otherSelectors.sessionTanggalInput.value = localStorage.getItem('sessionTanggal') || new Date().toISOString().slice(0, 10);
                otherSelectors.sessionCatatanInput.value = localStorage.getItem('sessionCatatan') || '';

                try {
                    // PERBAIKAN: Inisialisasi DB harus terjadi SEBELUM fungsi apa pun yang memanggilnya.
                    await dbLogic.init();

                    // Setelah DB siap, baru atur bahasa dan UI lainnya.
                    let preferredLang = localStorage.getItem('scannerLang');
                    // PERBAIKAN: Sanitasi input bahasa untuk mencegah nilai yang tidak valid.
                    if (preferredLang !== 'id' && preferredLang !== 'en') {
                        preferredLang = 'id';
                        localStorage.setItem('scannerLang', 'id'); // Perbaiki juga di penyimpanan
                    }
                    setLanguage(preferredLang);

                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionIdFromUrl = urlParams.get('sesi');
                    const sessionAcaraFromUrl = urlParams.get('acara');
                    const savedSession = JSON.parse(localStorage.getItem('collaborationSession'));

                    if (sessionIdFromUrl && sessionAcaraFromUrl) {
                        if (savedSession && savedSession.sessionId === sessionIdFromUrl && savedSession.marketingName) {
                            collaborationSession = savedSession;
                            setupCollaborationModeUI();
                        } else {
                            joinSessionName.textContent = sessionAcaraFromUrl;
                            joinSessionModal.classList.remove('hidden');
                        }
                    } else if (savedSession) {
                        collaborationSession = savedSession;
                        setupCollaborationModeUI();
                    }
                    
                    showScreen('initial');
                } catch (error) {
                    logError("Failed to initialize the app", error);
                    document.body.innerHTML = `<div class="text-center p-8 text-red-500">Failed to load database. App cannot run.</div>`;
                }
            }
            
            // Event Listeners
            [otherSelectors.langToggleInitial, otherSelectors.langToggleResults].forEach(btn => btn.addEventListener('click', toggleLanguage));

            createSessionBtn.addEventListener('click', () => showScreen('createSession'));
            cancelCreateSessionBtn.addEventListener('click', () => showScreen('initial'));
            
            generateSessionQRBtn.addEventListener('click', () => {
                const acara = collabSessionNameInput.value.trim();
                if (!acara) { showToast(getTranslation('toastEmptyEventName')); return; }
                const sessionId = acara.replace(/\s+/g, '-') + '-' + Date.now().toString(36);
                const baseUrl = window.location.origin + window.location.pathname;
                const collabUrl = `${baseUrl}?sesi=${sessionId}&acara=${encodeURIComponent(acara)}`;
                qrCodeContainer.innerHTML = '';
                new QRCode(qrCodeContainer, { text: collabUrl, width: 256, height: 256 });
                showSessionQRModal.classList.remove('hidden');
            });
            
            closeQrModalBtn.addEventListener('click', () => {
                showSessionQRModal.classList.add('hidden');
                showScreen('initial');
            });
            
            confirmJoinBtn.addEventListener('click', () => {
                const marketingName = marketingNameInput.value.trim();
                if (!marketingName) { showToast(getTranslation('toastEmptyMarketingName')); return; }
                const urlParams = new URLSearchParams(window.location.search);
                collaborationSession = {
                    isActive: true,
                    sessionId: urlParams.get('sesi'),
                    sessionAcara: urlParams.get('acara'),
                    marketingName: marketingName
                };
                localStorage.setItem('collaborationSession', JSON.stringify(collaborationSession));
                joinSessionModal.classList.add('hidden');
                setupCollaborationModeUI();
                showToast(getTranslation('toastWelcome', marketingName));
            });

            cancelJoinBtn.addEventListener('click', () => {
                joinSessionModal.classList.add('hidden');
                const url = new URL(window.location);
                url.searchParams.delete('sesi');
                url.searchParams.delete('acara');
                window.history.pushState({}, '', url);
                showScreen('initial');
            });

            exitCollabBtn.addEventListener('click', exitCollaborationMode);
            otherSelectors.startScanBtn.addEventListener('click', startCamera);
            otherSelectors.uploadBtn.addEventListener('click', () => otherSelectors.imageUploadInput.click());
            otherSelectors.imageUploadInput.addEventListener('change', handleImageUpload);
            otherSelectors.captureBtn.addEventListener('click', captureAndProcess);
            otherSelectors.cancelScanBtn.addEventListener('click', () => { stopCamera(); showScreen('initial'); });
            otherSelectors.viewResultsBtn.addEventListener('click', () => showScreen('results'));
            otherSelectors.backToHomeBtn.addEventListener('click', () => showScreen('initial'));
            otherSelectors.clearAllBtn.addEventListener('click', () => {
                showConfirmModal(getTranslation('confirmClearAll'),
                    async () => {
                        await dbLogic.clearAllContacts();
                        await refreshResults();
                        showToast(getTranslation('toastAllDataDeleted'));
                    }
                );
            });
            otherSelectors.saveEditBtn.addEventListener('click', saveContactChanges);
            
            otherSelectors.cancelEditBtn.addEventListener('click', () => {
                const idValue = document.getElementById('edit-contact-id').value;
                const isNewContact = !idValue;
                
                if (isNewContact) {
                    closeEditModal(); 
                    showToast(getTranslation('toastScanCancelled'));
                } else {
                    closeEditModal();
                }
            });
            otherSelectors.deleteContactBtn.addEventListener('click', handleDeleteContact);
            [otherSelectors.themeToggleInitial, otherSelectors.themeToggleResults].forEach(btn => btn.addEventListener('click', toggleTheme));
            otherSelectors.sessionAcaraInput.addEventListener('input', (e) => localStorage.setItem('sessionAcara', e.target.value));
            otherSelectors.sessionTanggalInput.addEventListener('input', (e) => localStorage.setItem('sessionTanggal', e.target.value));
            otherSelectors.sessionCatatanInput.addEventListener('input', (e) => localStorage.setItem('sessionCatatan', e.target.value));
            otherSelectors.cancelConfirmBtn.addEventListener('click', hideConfirmModal);
            otherSelectors.confirmActionBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            // --- Profile Screen Listeners ---
            otherSelectors.profileSettingsBtn.addEventListener('click', () => {
                loadAndDisplayProfile();
                showScreen('profile');
            });
            otherSelectors.backToHomeFromProfile.addEventListener('click', () => showScreen('initial'));
            otherSelectors.saveProfileBtn.addEventListener('click', () => {
                const profile = {
                    nama: document.getElementById('profile-nama').value,
                    jabatan: document.getElementById('profile-jabatan').value,
                    perusahaan: document.getElementById('profile-perusahaan').value,
                    deskripsi: document.getElementById('profile-deskripsi').value,
                };
                localStorage.setItem('userProfile', JSON.stringify(profile));
                showToast(getTranslation('toastProfileSaved'));
                showScreen('initial');
            });
            otherSelectors.closeActionModalBtn.addEventListener('click', closeActionModal);
            
            // Log Viewer Event Listeners
            logIcon.addEventListener('click', () => {
                logViewerModal.classList.remove('hidden');
                lucide.createIcons();
            });
            closeLogViewerBtn.addEventListener('click', () => logViewerModal.classList.add('hidden'));
            clearLogsBtn.addEventListener('click', () => {
                errorLogs = [];
                renderLogs();
            });
            copyLogsBtn.addEventListener('click', () => {
                if (errorLogs.length === 0) {
                    showToast(getTranslation('toastNoLogs'));
                    return;
                }
                const logText = errorLogs.map(log => `[${log.timestamp}] ${log.message}\n${log.details}`).join('\n\n');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(logText).then(() => {
                        showToast(getTranslation('toastLogsCopied'));
                    }).catch(err => {
                        logError('Failed to copy logs with Clipboard API', err);
                        showToast(getTranslation('toastCouldNotCopy'));
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = logText;
                    textArea.style.position = 'fixed';  textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast(getTranslation('toastLogsCopied'));
                    } catch (err) {
                        logError('Failed to copy logs with fallback', err);
                        showToast(getTranslation('toastCouldNotCopy'));
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pintar | Aplikasi Scanner Kartu Nama & QR Code Berbasis AI</title>

    <!-- Favicon -->
    <link rel="icon" href="scanner-pintar.ico" type="image/x-icon">

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#4f46e5"/>

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Pintar">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Tagify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Google API Libraries -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid rgba(0,0,0,0.1); border-top-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: rgba(255,255,255,0.2); border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.6)); }
        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 80%; max-width: 320px; aspect-ratio: 1/1; border: 2px dashed rgba(255,255,255,0.5); border-radius: 1.5rem; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-button { padding: .75rem 1.25rem; height: 48px; display: inline-flex; align-items: center; justify-content: center; text-align: center; font-weight: 600; border-radius: .5rem; transition: all .2s ease-in-out; white-space: nowrap; }
        #scan-mode-label { transition: opacity .3s ease; }
        .btn-loader { width: 20px !important; height: 20px !important; border-width: 2px !important; }
        #qr-code-container { display: flex; justify-content: center; align-items: center; background: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        #log-icon { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; }
        #log-viewer-modal .log-entry { border-bottom: 1px solid #4a5568; }
        #log-viewer-modal .log-entry:last-child { border-bottom: none; }
        .contact-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .contact-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dark .contact-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Tagify Custom Styles */
        .tagify { --tag-bg: #e5e7eb; --tag-hover: #d1d5db; --tag-text-color: #1f2937; --tags-border-color: #d1d5db; }
        .dark .tagify { --tag-bg: #374151; --tag-hover: #4b5563; --tag-text-color: #f3f4f6; --tags-border-color: #4b5563; }
        .tagify__input { font-size: 1rem; }
        .tagify__tag > div::before { background: var(--tag-hover); }

        .filter-dropdown { transition: opacity 0.2s ease, transform 0.2s ease; }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="app-container max-w-lg mx-auto shadow-2xl min-h-screen flex flex-col bg-gray-50 dark:bg-[#0D1117] relative">
        <div id="collaboration-mode-indicator" class="hidden sticky top-0 bg-indigo-600 text-white text-xs text-center p-2 z-20 shadow-lg">
            <strong data-translate-key="collabMode">Mode Kolaborasi:</strong> <span id="collab-session-name"></span> | <strong data-translate-key="collabUser">User:</strong> <span id="collab-user-name"></span>
            <button id="exit-collab-btn" class="absolute top-1/2 right-2 -translate-y-1/2 text-indigo-200 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <main class="main-content flex-grow flex flex-col">
            <div id="initial-screen" class="screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                 <div class="absolute top-5 right-5 z-30 flex items-center gap-2">
                    <button id="lang-toggle-initial" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">EN</button>
                    <button id="profile-settings-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                        <i data-lucide="user" class="sm:hidden w-5 h-5"></i>
                        <span class="hidden sm:inline" data-translate-key="profileBtn">PROFIL</span>
                    </button>
                    <button id="theme-toggle-initial" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                        <i data-lucide="sun" class="sm:hidden w-5 h-5"></i>
                        <i data-lucide="moon" class="sm:hidden w-5 h-5"></i>
                        <span class="hidden sm:inline" data-translate-key="themeBtn">TEMA</span>
                    </button>
                </div>
                <div class="w-full pt-16">
                    <div class="flex justify-center mb-8">
                        <img src="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar.png" alt="Logo Scanner Pintar" class="w-24 h-24 rounded-full">
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white" data-translate-key="appTitle">SCANNER PINTAR</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-2" data-translate-key="appSubtitle">Scanner Kartu Nama & QR Code Berbasis AI</p>
                </div>
                <div id="session-form-container" class="w-full text-left my-8 space-y-4">
                    <div><label for="session-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="eventNameLabel">Nama Acara</label><input type="text" id="session-acara" data-translate-key-placeholder="eventNamePlaceholder" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="session-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="dateLabel">Tanggal</label><input type="text" id="session-tanggal" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label for="session-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="notesLabel">Catatan</label><input type="text" id="session-catatan" data-translate-key-placeholder="notesPlaceholder" placeholder="Opsional" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    </div>
                </div>
                <div class="w-full flex flex-col gap-4">
                     <button id="start-scan-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg" data-translate-key="scanCardBtn">SCAN KARTU NAMA</button>
                     <button id="upload-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg" data-translate-key="uploadGalleryBtn">UPLOAD DARI GALERI</button>
                     <div class="border-t border-gray-200 dark:border-gray-700 w-3/4 mx-auto my-2"></div>
                     <button id="create-session-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center justify-center gap-3 text-base" data-translate-key="collabModeBtn">MODE KOLABURASI TIM</button>
                     <button id="view-results-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center gap-2 uppercase"><span data-translate-key="viewResultsBtn">LIHAT HASIL SCAN</span> <span id="home-contact-count" class="bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-2 py-0.5 rounded-full">0</span></button>
                </div>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
            </div>

            <div id="create-session-screen" class="hidden screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                <h2 class="text-2xl font-bold" data-translate-key="createCollabTitleV2">Mode Kolaborasi (Host)</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2 mb-4" data-translate-key="createCollabSubtitleV2">Isi detail di bawah ini untuk membuat QR Code bagi tim Anda.</p>
                <p class="text-sm text-indigo-600 dark:text-indigo-400 mb-8">
                    <a href="#" id="show-collab-help-btn" class="hover:underline" data-translate-key="collabHelpLink">Butuh bantuan? Baca petunjuk lengkap di sini.</a>
                </p>
                <div class="w-full max-w-sm text-left space-y-4">
                    <div>
                        <label for="collab-apps-script-url" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="appsScriptUrlLabel">URL Web App Apps Script</label>
                        <input type="url" id="collab-apps-script-url" data-translate-key-placeholder="appsScriptUrlPlaceholder" placeholder="Salin & tempel URL dari Google Apps Script" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="collab-event-name" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="collabEventNameLabel">Nama Acara / Event</label>
                        <input type="text" id="collab-event-name" data-translate-key-placeholder="collabEventNamePlaceholder" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="collab-secret-key" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="secretKeyLabel">Secret Key</label>
                        <input type="password" id="collab-secret-key" data-translate-key-placeholder="secretKeyPlaceholder" placeholder="Kunci rahasia dari Apps Script" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                     <div class="flex gap-4 pt-2">
                        <button id="cancel-create-session-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-full" data-translate-key="cancelBtn">BATAL</button>
                        <button id="generate-qr-code-v2-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-full uppercase" data-translate-key="createQrBtn">Buat QR Code</button>
                     </div>
                </div>
            </div>

            <div id="profile-screen" class="hidden screen flex-col">
                <header class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold" data-translate-key="myProfileTitle">Profil Saya</h2>
                    <button id="back-to-home-from-profile" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </header>

                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button id="tab-profile" class="profile-tab w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-indigo-600 dark:text-indigo-400 border-indigo-500" aria-current="page" data-translate-key="profileTab">
                            Profil
                        </button>
                        <button id="tab-qrcode" class="profile-tab w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 border-transparent hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-700" data-translate-key="vCardTab">
                            vCard QR Code
                        </button>
                    </nav>
                </div>

                <div id="tab-content-profile" class="p-8 space-y-4 flex-grow overflow-y-auto">
                    <div class="flex flex-col items-center space-y-2">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="profilePhotoLabel">Foto Profil</p>
                        <img id="profile-photo-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiByeD0iNjQiIGZpbGw9IiNFNEU0RTciLz4KPHBhdGggZD0iTTk0LjYwNTYgMTAzLjkxOUM5Mi4yMDI0IDEwMS43MDQgODguNzAyMSA5OS4zOTIgODQuODU2MiA5Ni43MDM5Qzc3LjgwNjYgOTEuNTc1MyA2OS41NDYxIDg4IDYwLjQzNTYgODhDNTEuMzI1MSA4OCA0My4wNjQ2IDkxLjU3NTMgMzUuMDE1IDk2LjcwMzlDMzEuMTY5MSA5OS4zOTIgMjcuNjY4OCAxMDEuNzA0IDI1LjI2NTYgMTAzLjkxOUMyMS4zNTIgMTA3LjU2NSAxOC4zMDgzIDEwOS4yMDggMTggMTA4LjAwMkMxOCAxMDQuNzM2IDIyLjEyMDQgOTQuODEzNyAyOS4zNjA4IDgzLjY3NjlDNjAuNDM1NiA0NC44ODIgNjkuNjE2MyA0NS40NDQxIDk2LjUwMDQgODMuNjc2OUMxMDMuNzQxIDk0LjgxMzcgMTA3Ljg2MSAxMDQuNzM2IDEwNy44NjEgMTA4LjAwMkMxMDcuNTUzIDEwOS4zMjkgMTA0Ljc2MiAxMDcuODQyIDEwMy4yMDkgMTA2LjQzMkM5OS44ODcyIDEwMy40MDkgOTcuMjc0OCAxMDEuOTg2IDk0LjYwNTYgMTAzLjkxOVoiIGZpbGw9IiNBMEEwQUIiLz4KPHBhdGggZD0iTTYwLjQzNTYgNzZDNzAuMzkxOCA3NiA3OC41MjE4IDY3Ljg2OTkgNzgLjUyMTggNTcuOTEzOEM3OC41MjE4IDQ4LjA1NzYgNzAuMzkxOCAzOS45MjczIDYwLjQzNTYgMzkuOTI3M0M1MC40Nzk0IDM5LjkzNzMgNDIuMzQ5NCA0OC4wNTc2IDQyLjM0OTQgNTcuOTEzOEM0Mi4zNDk0IDY3Ljg2OTkgNTAuNDc5NCA3NiA2MC40MzU2IDc2WiIgZmlsbD0iI0EwQTBBQiIvPgo8L3N2Zz4K" alt="" class="w-32 h-32 rounded-full object-cover bg-gray-200 dark:bg-gray-700">
                        <input type="file" id="profile-photo-input" class="hidden" accept="image/*">
                        <button id="upload-photo-btn" class="text-sm text-indigo-600 hover:underline" data-translate-key="uploadPhotoBtn">Upload Foto</button>
                    </div>
                    <div><label for="profile-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourNameLabel">Nama Anda</label><input type="text" id="profile-nama" data-translate-key-placeholder="yourNamePlaceholder" placeholder="Cth: Isparmo" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourPositionLabel">Jabatan Anda</label><input type="text" id="profile-jabatan" data-translate-key-placeholder="yourPositionPlaceholder" placeholder="Cth: Marketing Manager" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourCompanyLabel">Nama Perusahaan Anda</label><input type="text" id="profile-perusahaan" data-translate-key-placeholder="yourCompanyPlaceholder" placeholder="Cth: PT Multibangun Rekatama Patria" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-whatsapp" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourContactLabel">No. HP/WA</label><input type="tel" id="profile-whatsapp" placeholder="Cth: 081234567890" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-email" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourEmailLabel">Email</label><input type="email" id="profile-email" placeholder="Cth: marketing@mrp.co.id" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-website" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourWebsiteLabel">Website</label><input type="url" id="profile-website" placeholder="Cth: https://www.mrp.co.id" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-telp-kantor" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="yourOfficePhoneLabel">Telp. Kantor</label><input type="tel" id="profile-telp-kantor" placeholder="Cth: 021-1234567" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="profile-deskripsi" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="notesFromDesc">Catatan (dari Deskripsi Perusahaan)</label><textarea id="profile-deskripsi" rows="3" data-translate-key-placeholder="companyDescPlaceholder" placeholder="Cth: Spesialis Geosintetik sejak 1995..." class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea></div>
                </div>

                <div id="tab-content-qrcode" class="hidden p-8 flex-grow flex flex-col items-center justify-center">
                    <div id="profile-qrcode-container" class="p-4 bg-white rounded-lg shadow-md min-h-[288px] w-[288px] flex items-center justify-center">
                        <p id="qrcode-prompt" class="text-center text-sm text-gray-500 px-4" data-translate-key="generateQrPrompt">Klik tombol di bawah untuk membuat QR Code dari data profil Anda yang tersimpan.</p>
                    </div>
                    <div class="mt-6 w-full flex flex-col gap-3">
                         <button id="generate-qrcode-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-full" data-translate-key="generateQrBtn">Generate QR Code</button>
                         <div id="download-buttons-wrapper" class="hidden w-full flex flex-col gap-3">
                             <button id="download-qrcode-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full" data-translate-key="downloadQrPng">Download QR Code (PNG)</button>
                             <button id="download-vcf-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full" data-translate-key="downloadVcf">Download vCard (.vcf)</button>
                         </div>
                    </div>
                </div>

                <footer class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button id="import-profile-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full text-sm">IMPOR PROFIL</button>
                        <button id="export-profile-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full text-sm">EKSPOR PROFIL</button>
                    </div>
                    <input type="file" id="import-profile-input" class="hidden" accept=".spro">
                    <button id="save-profile-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full" data-translate-key="saveProfileBtn">SIMPAN PROFIL</button>
                </footer>
            </div>

            <div id="scanner-screen" class="hidden screen relative bg-black flex-grow"><video id="video" autoplay playsinline></video><div class="scan-frame"></div><div class="camera-overlay p-6"><div class="flex justify-between items-center"><p id="scan-mode-label" class="text-white font-medium text-sm bg-black/50 px-3 py-1 rounded-full" data-translate-key="scanInstructions">Arahkan ke Kartu Nama atau QR Code</p><button id="cancel-scan-btn" class="p-3 bg-black/50 rounded-full text-white hover:bg-black/80"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex justify-center items-center"><button id="capture-btn" class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-2xl ring-4 ring-white/30 transition-transform transform hover:scale-110" data-translate-key="scanBtn">SCAN</button></div></div><canvas id="canvas" class="hidden"></canvas></div>
            <div id="processing-screen" class="hidden screen justify-center items-center text-center p-8 flex-grow"><div class="loader mb-6"></div><h2 id="processing-title" class="text-2xl font-bold text-gray-900 dark:text-white animate-pulse" data-translate-key="processingTitle">AI Menganalisis Gambar...</h2><p class="text-gray-500 dark:text-gray-400 mt-2" data-translate-key="processingSubtitle">Mohon tunggu sebentar...</p></div>

            <div id="results-screen" class="hidden screen flex flex-col">
                <header class="p-6 flex justify-between items-center gap-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex-grow" data-translate-key="scanResultTitle">Hasil Scan</h2>
                    <button id="lang-toggle-results" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">EN</button>
                    <button id="back-to-home-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-sm uppercase tracking-wider transition-colors flex items-center justify-center w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 whitespace-nowrap"><i data-lucide="home" class="w-5 h-5 sm:hidden"></i><span class="hidden sm:inline" data-translate-key="mainMenuBtn">MENU UTAMA</span></button>
                    <button id="theme-toggle-results" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-full text-xs uppercase tracking-wider transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 flex items-center justify-center">
                        <i data-lucide="sun" class="sm:hidden w-5 h-5"></i>
                        <i data-lucide="moon" class="sm:hidden w-5 h-5"></i>
                        <span class="hidden sm:inline" data-translate-key="themeBtnResults">TEMA</span>
                    </button>
                </header>
                <div class="p-6 flex-shrink-0">
                    <div class="relative">
                        <input type="search" id="search-input" data-translate-key-placeholder="searchPlaceholder" class="w-full p-3 pl-10 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <button id="filter-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                            <i data-lucide="filter" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="filter-dropdown" class="hidden filter-dropdown absolute right-6 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-4 z-10 origin-top-right opacity-0 scale-95">
                        <h4 class="font-semibold mb-2" data-translate-key="filterByTag">Filter Berdasarkan Tag</h4>
                        <div id="tag-filter-list" class="flex flex-wrap gap-2 mb-4"></div>
                        <button id="clear-filter-btn" class="w-full text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-translate-key="clearFilter">Hapus Filter</button>
                    </div>
                </div>
                <div id="import-export-controls" class="px-6 pt-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <button id="import-btn" class="text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold py-2 px-3 rounded-lg flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span data-translate-key="importBtn">Import</span>
                        </button>
                        <button id="export-selected-btn" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg flex items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            <span data-translate-key="exportBtn">Export</span>
                        </button>
                        <input type="file" id="import-file-input" class="hidden" accept=".spdt">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="select-all-checkbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-200" data-translate-key="selectAllLabel">Pilih Semua</label>
                    </div>
                </div>
                <div class="flex-grow p-6 pt-0 overflow-y-auto">
                    <p class="text-gray-600 dark:text-gray-400 mt-4 mb-4"><span id="results-contact-count" class="font-bold">0</span> <span data-translate-key="totalContactsPart2">kontak ditemukan.</span></p>
                    <div id="results-list" class="space-y-3"></div>
                </div>
                <footer id="results-footer" class="p-6 border-t border-gray-200 dark:border-gray-700">
                    <div id="export-buttons-container" class="grid grid-cols-2 gap-4"></div>
                    <button id="clear-all-btn" class="col-span-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg mt-4 flex items-center justify-center gap-2 uppercase" data-translate-key="deleteAllLocalDataBtn">HAPUS SEMUA DATA LOKAL</button>
                </footer>
            </div>
        </main>
        <footer class="text-center p-6 space-y-2 text-sm text-gray-500 dark:text-gray-400">
            <div class="flex justify-center items-center gap-x-4">
                <a href="about.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerAbout">Tentang</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="help.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerHelp">Bantuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="terms.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerTerms">Ketentuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="privacy.html" class="hover:underline hover:text-indigo-500" data-translate-key="footerPrivacy">Privasi</a>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-600 pt-2" data-translate-key="footerCopyright">&copy; 2025 SCANNER PINTAR oleh Isparmo & M. Hasan</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="collab-help-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl transform scale-95 opacity-0">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold" data-translate-key="collabHelpTitle">Petunjuk Pengaturan Mode Kolaborasi</h3>
                <button id="close-collab-help-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="collab-help-content" class="p-6 max-h-[70vh] overflow-y-auto text-sm text-gray-700 dark:text-gray-300 space-y-4">
                    <p data-translate-key="collabHelpIntro">Mode Kolaborasi memungkinkan Anda (sebagai Host) untuk mengumpulkan semua data pindaian dari tim Anda ke dalam satu Google Sheet. Ikuti langkah-langkah di bawah ini untuk menyiapkannya.</p>

                    <h4 class="text-lg font-semibold pt-2" data-translate-key="collabHelpStep1Title">Langkah 1: Siapkan Google Sheet Anda</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li data-translate-key="collabHelpStep1Item1">Buka Google Sheet yang sudah ada atau buat yang baru. Ini akan menjadi tempat semua data tim Anda disimpan.</li>
                        <li data-translate-key="collabHelpStep1Item2">Klik menu <strong>Extensions</strong> &gt; <strong>Apps Script</strong>. Ini akan membuka editor skrip di tab baru.</li>
                    </ol>

                    <h4 class="text-lg font-semibold pt-2" data-translate-key="collabHelpStep2Title">Langkah 2: Salin dan Tempel Kode Skrip</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li data-translate-key="collabHelpStep2Item1">Hapus semua kode contoh yang ada di editor Apps Script.</li>
                        <li data-translate-key="collabHelpStep2Item2">Salin seluruh kode di bawah ini dan tempelkan ke dalam editor.</li>
                    </ol>
                    <div class="relative">
                        <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg text-xs overflow-x-auto"><code>// INSTRUCTIONS FOR HOST (v2):
// 1. Open your Google Sheet.
// 2. Go to Extensions > Apps Script.
// 3. Copy all the code from this file and paste it into the \`Code.gs\` file in the Apps Script editor.
// 4. CHANGE THE \`YOUR_SECRET_KEY\` variable below to a strong, unique secret key.
// 5. Click the "Deploy" button > "New deployment".
// 6. For "Select type", choose "Web app".
// 7. In the "Description" field, you can write "Business Card Scanner Collaboration v2".
// 8. For "Execute as", select "Me".
// 9. For "Who has access", select "Anyone". **IMPORTANT: This is necessary for the script to receive data.**
// 10. Click "Deploy".
// 11. On the next screen, click "Authorize access" and approve the permissions for the script to edit your Google Sheets.
// 12. After authorization, it will show you a "Web app URL". COPY this URL. You will need it for the Scanner Pintar app.

// --- START OF SCRIPT ---

// CONFIGURATION: Change this key to your own secret password.
const SECRET_KEY = "YOUR_SECRET_KEY_HERE";

// Define the exact header columns and their order to match the app's "Edit Kontak" form.
const HEADERS = [
  "Timestamp", "Team Member", "Nama", "Jabatan", "Perusahaan", "Jenis Perusahaan",
  "Telepon Kantor", "WhatsApp", "Email", "Tags", "Acara", "Tanggal", "Catatan"
];

function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const { key, eventName, teamMember, cardData } = requestData;

    if (key !== SECRET_KEY) {
      return createJsonResponse({ "status": "error", "message": "Invalid Secret Key." });
    }
    if (!eventName || !teamMember || !cardData) {
      return createJsonResponse({ "status": "error", "message": "Missing required data: eventName, teamMember, or cardData." });
    }

    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName(eventName);
    if (!sheet) {
      sheet = spreadsheet.insertSheet(eventName);
      sheet.appendRow(HEADERS);
    }

    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues();
    const headerRow = values[0];
    const nameIndex = headerRow.indexOf("Nama");
    const companyIndex = headerRow.indexOf("Perusahaan");
    const whatsappIndex = headerRow.indexOf("WhatsApp");

    let existingRowIndex = -1;
    if (nameIndex > -1 && companyIndex > -1 && whatsappIndex > -1) {
      for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (row[nameIndex] === cardData.nama &&
            row[companyIndex] === cardData.perusahaan &&
            row[whatsappIndex] === cardData.whatsapp) {
          existingRowIndex = i + 1;
          break;
        }
      }
    }

    const timestamp = new Date();
    const newRowData = HEADERS.map(header => {
        switch(header) {
            case "Timestamp": return timestamp;
            case "Team Member": return teamMember;
            case "Nama": return cardData.nama || "";
            case "Jabatan": return cardData.jabatan || "";
            case "Perusahaan": return cardData.perusahaan || "";
            case "Jenis Perusahaan": return cardData.jenis_perusahaan || "";
            case "Telepon Kantor": return cardData.telepon_kantor ? "'" + cardData.telepon_kantor : "";
            case "WhatsApp": return cardData.whatsapp || "";
            case "Email": return cardData.email || "";
            case "Tags": return (cardData.tags || []).join(', ');
            case "Acara": return cardData.acara || "";
            case "Tanggal": return cardData.tanggal || "";
            case "Catatan": return cardData.catatan || "";
            default: return "";
        }
    });

    if (existingRowIndex !== -1) {
      const range = sheet.getRange(existingRowIndex, 1, 1, HEADERS.length);
      range.setValues([newRowData]);
    } else {
      sheet.appendRow(newRowData);
    }
    return createJsonResponse({ "status": "success" });
  } catch (error) {
    return createJsonResponse({ "status": "error", "message": error.toString() });
  }
}

function createJsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
</code></pre>
                        <button class="copy-code-btn absolute top-2 right-2 p-2 bg-gray-300 dark:bg-gray-700 rounded-md text-xs hover:bg-gray-400 dark:hover:bg-gray-600" data-translate-key="collabHelpCopyCodeBtn">Salin Kode</button>
                    </div>

                    <h4 class="text-lg font-semibold pt-2" data-translate-key="collabHelpStep3Title">Langkah 3: Atur Kunci Rahasia (Secret Key)</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li data-translate-key="collabHelpStep3Item1">Di dalam kode yang baru saja Anda tempel, cari baris: <br><code>const SECRET_KEY = "GANTI_DENGAN_KUNCI_RAHASIA_ANDA";</code></li>
                        <li data-translate-key="collabHelpStep3Item2">Ganti <code>GANTI_DENGAN_KUNCI_RAHASIA_ANDA</code> dengan kata sandi unik Anda sendiri. <strong>Penting:</strong> Kunci ini harus sama persis dengan yang Anda masukkan di aplikasi Scanner Pintar.</li>
                        <li data-translate-key="collabHelpStep3Item3">Simpan proyek skrip dengan mengklik ikon disket.</li>
                    </ol>

                    <h4 class="text-lg font-semibold pt-2" data-translate-key="collabHelpStep4Title">Langkah 4: Deploy sebagai Web App</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li data-translate-key="collabHelpStep4Item1">Klik tombol biru <strong>Deploy</strong> di kanan atas, lalu pilih <strong>New deployment</strong>.</li>
                        <li data-translate-key="collabHelpStep4Item2">Di sebelah "Select type", klik ikon roda gigi dan pilih <strong>Web app</strong>.</li>
                        <li data-translate-key="collabHelpStep4Item3">Pada bagian "Configuration":
                            <ul class="list-disc list-inside pl-6 mt-1">
                                <li data-translate-key="collabHelpStep4Item3a"><strong>Description:</strong> (Opsional) Beri nama, contohnya "Scanner Pintar Kolaborasi".</li>
                                <li data-translate-key="collabHelpStep4Item3b"><strong>Execute as:</strong> Pilih <strong>Me</strong>.</li>
                                <li data-translate-key="collabHelpStep4Item3c"><strong>Who has access:</strong> Pilih <strong>Anyone</strong>. Ini penting agar aplikasi bisa mengirim data.</li>
                            </ul>
                        </li>
                        <li data-translate-key="collabHelpStep4Item4">Klik <strong>Deploy</strong>.</li>
                    </ol>

                    <h4 class="text-lg font-semibold pt-2" data-translate-key="collabHelpStep5Title">Langkah 5: Otorisasi dan Salin URL</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li data-translate-key="collabHelpStep5Item1">Google akan meminta izin. Klik <strong>Authorize access</strong> dan ikuti petunjuk untuk menyetujui akses skrip ke Google Sheet Anda.</li>
                        <li data-translate-key="collabHelpStep5Item2">Setelah berhasil, Anda akan melihat jendela "Deployment successful". Salin <strong>Web app URL</strong> yang ditampilkan.</li>
                        <li data-translate-key="collabHelpStep5Item3">URL inilah yang Anda tempel ke kolom "URL Web App Apps Script" di aplikasi Scanner Pintar.</li>
                    </ol>

                    <p class="pt-4 font-semibold" data-translate-key="collabHelpOutro">Selesai! Sekarang Anda bisa mengisi ketiga kolom di aplikasi, membuat QR Code, dan membagikannya ke tim Anda.</p>
                </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 text-right">
                <button id="ok-collab-help-modal-btn" class="modal-button bg-indigo-600 text-white hover:bg-indigo-700" data-translate-key="collabHelpUnderstandBtn">Mengerti</button>
            </div>
        </div>
    </div>

    <div id="action-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-end sm:items-center sm:justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full sm:scale-95 sm:translate-y-0 opacity-0"><div class="flex justify-between items-start mb-4"><div id="action-modal-header"></div><button id="close-action-modal-btn" class="p-2 -mr-2 -mt-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button></div><div id="action-modal-body" class="text-sm text-gray-600 dark:text-gray-400 mb-6"></div><div id="action-modal-footer" class="grid grid-cols-2 gap-3"></div></div></div>
    <div id="reminder-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mb-4" data-translate-key="reminderTitle">Buat Pengingat Janji</h3>
            <form id="reminder-form" class="space-y-3">
                <input type="hidden" id="reminder-contact-id">
                <div>
                    <label for="reminder-type" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderTypeLabel">Reminder Apa</label>
                    <select id="reminder-type" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="Meeting/Presentasi">Meeting/Presentasi</option>
                        <option value="Kirim Brosur">Kirim Brosur</option>
                        <option value="Kirim Penawaran">Kirim Penawaran</option>
                        <option value="Janji Ketemu">Janji Ketemu</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                    <input type="text" id="reminder-type-other" class="hidden w-full mt-2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Ketik jenis reminder...">
                </div>
                <div>
                    <label for="reminder-location" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderLocationLabel">Tempat</label>
                    <input type="text" id="reminder-location" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="reminder-date" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderDateLabel">Tanggal</label>
                        <input type="text" id="reminder-date" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="reminder-time" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderTimeLabel">Jam</label>
                        <input type="time" id="reminder-time" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                </div>
                <div>
                    <label for="reminder-alarm" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderAlarmLabel">Waktu Pengingat</label>
                    <select id="reminder-alarm" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="-P1D">Sehari Sebelumnya</option>
                        <option value="-PT1H">Sejam Sebelumnya</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                    <input type="text" id="reminder-alarm-other" class="hidden w-full mt-2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="Contoh: -P2D (2 hari) atau -PT2H (2 jam)">
                </div>
                <div>
                    <label for="reminder-notes" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="reminderNotesLabel">Catatan</label>
                    <textarea id="reminder-notes" rows="3" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea>
                </div>
            </form>
            <div class="mt-6 flex items-center gap-3">
                <button id="cancel-reminder-btn" class="modal-button bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 flex-1" data-translate-key="cancelBtn">Batal</button>
                <button id="create-reminder-btn" class="modal-button bg-indigo-600 hover:bg-indigo-700 text-white flex-1" data-translate-key="createReminderBtn">BUAT REMINDER</button>
            </div>
        </div>
    </div>
    <div id="show-session-qr-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6 text-center"><h3 class="text-xl font-bold mb-2" data-translate-key="sessionCreatedTitle">Sesi Dibuat!</h3><p class="text-gray-600 dark:text-gray-400 mb-4" data-translate-key="sessionCreatedSubtitle">Bagikan QR Code ini ke tim Anda untuk bergabung.</p><div id="qr-code-container"></div><button id="close-qr-modal-btn" class="modal-button w-full mt-6 bg-indigo-600 text-white hover:bg-indigo-700" data-translate-key="doneBtn">SELESAI</button></div></div>
    <div id="join-session-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6"><h3 class="text-xl font-bold mb-2" data-translate-key="joinCollabTitle">Gabung Sesi Kolaborasi</h3><p class="text-gray-600 dark:text-gray-400 mb-4"><span data-translate-key="joinCollabInvite">Anda diundang ke sesi</span> <strong id="join-session-name" class="text-indigo-500"></strong>. <span data-translate-key="joinCollabPrompt">Masukkan nama Anda:</span></p><input type="text" id="marketing-name-input" data-translate-key-placeholder="yourNameLabel" placeholder="Nama Anda" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"><div class="flex gap-4 mt-6"><button id="cancel-join-btn" class="modal-button flex-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300" data-translate-key="cancelBtn">BATAL</button><button id="confirm-join-btn" class="modal-button flex-1 bg-indigo-600 text-white hover:bg-indigo-700" data-translate-key="joinBtn">GABUNG</button></div></div></div>

    <div id="edit-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0"><h3 class="text-xl font-bold mb-4" data-translate-key="editContactTitle">Edit Kontak</h3><form id="edit-form" class="space-y-3"><input type="hidden" id="edit-contact-id"><div class="grid grid-cols-2 gap-3"><div><label for="edit-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="nameLabel">Nama</label><input type="text" id="edit-nama" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="positionLabel">Jabatan</label><input type="text" id="edit-jabatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="companyLabel">Perusahaan</label><input type="text" id="edit-perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jenis_perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="companyTypeLabel">Jenis Perusahaan</label><input type="text" id="edit-jenis_perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-telepon_kantor" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="officePhoneLabel">Telepon Kantor</label><input type="tel" id="edit-telepon_kantor" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-whatsapp" class="text-sm font-medium text-gray-600 dark:text-gray-400">WhatsApp</label><input type="tel" id="edit-whatsapp" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div><label for="edit-email" class="text-sm font-medium text-gray-600 dark:text-gray-400">Email</label><input type="email" id="edit-email" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
    <div>
        <label for="edit-tags" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="tagsLabel">Tags</label>
        <input type="text" id="edit-tags" name="edit-tags" placeholder="Pisahkan dengan koma" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
    </div>
    <hr class="border-gray-200 dark:border-gray-600 !my-4">
    <div><label for="edit-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="notesLabel">Catatan</label><input type="text" id="edit-catatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
    <div class="grid grid-cols-2 gap-3">
        <div><label for="edit-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="dateLabel">Tanggal</label><input type="text" id="edit-tanggal" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
        <div><label for="edit-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400" data-translate-key="eventLabel">Acara</label><input type="text" id="edit-acara" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
    </div>
    </form><div class="mt-6 flex items-center gap-3"><button id="delete-contact-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white flex-1 flex items-center justify-center gap-2" data-translate-key="deleteBtn">HAPUS</button><button id="cancel-edit-btn" class="modal-button bg-blue-600 hover:bg-blue-700 text-white flex-1" data-translate-key="cancelBtn">BATAL</button><button id="save-edit-btn" class="modal-button bg-green-600 hover:bg-green-700 text-white flex-1" data-translate-key="saveBtn">SIMPAN</button></div></div></div>

    <div id="confirm-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95 opacity-0"><h3 class="text-lg font-bold mb-2" data-translate-key="confirmActionTitle">Konfirmasi Tindakan</h3><p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6"></p><div class="flex justify-end items-center gap-3"><button id="cancel-confirm-btn" class="modal-button bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200" data-translate-key="cancelBtn">BATAL</button><button id="confirm-action-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white" data-translate-key="continueBtn">LANJUTKAN</button></div></div></div>
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 py-3 px-5 rounded-full shadow-lg opacity-0 transform translate-y-5 pointer-events-none"><p id="toast-message"></p></div>

    <!-- Log Viewer Elements -->
    <button id="log-icon" class="hidden p-2 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition-colors uppercase">Log</button>
    <div id="log-viewer-modal" class="modal-backdrop hidden fixed inset-0 bg-black/70 z-50 p-4 flex flex-col">
        <div class="modal-content w-full h-full max-w-4xl m-auto bg-gray-900 text-white rounded-lg shadow-2xl flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-bold">Frontend Error Log</h3>
                <button id="close-log-viewer-btn" class="p-1 hover:bg-gray-700 rounded-full text-gray-300 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </header>
            <div id="log-list" class="flex-grow p-4 overflow-y-auto font-mono text-sm space-y-2"></div>
            <footer class="p-3 border-t border-gray-700 flex-shrink-0 flex justify-end gap-4">
                <button id="copy-logs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-xs flex items-center gap-2 uppercase">Copy Logs</button>
                <button id="clear-logs-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md text-xs uppercase">Clear Logs</button>
            </footer>
        </div>
    </div>

    <!-- Tagify JS -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }

            let currentLang = 'id';
            let tagify;
            // ... (rest of the script is identical, so it's omitted for brevity)

            async function initializeApp() {
                lucide.createIcons();
                // ... (rest of initializeApp is identical)

                otherSelectors.sessionTanggalInput.value = localStorage.getItem('sessionTanggal') || getLocalDateString();

                // tagify = new Tagify(editTagsInput); // This line is commented out

                try {
                    await dbLogic.init();
                    // ... (rest of the try block is identical)

                    // Expose functions for Playwright testing
                    window.openEditModal = openEditModal;
                    window.openEditModalForNewContact = openEditModalForNewContact;

                    window.appInitialized = true; // Signal that the app is ready
                } catch (error) {
                    logError("Failed to initialize the app", error);
                    document.body.innerHTML = `<div class="text-center p-8 text-red-500">Failed to load database. App cannot run.</div>`;
                }
            }

            async function openEditModalForNewContact(contact) {
                document.querySelector('.app-container').classList.add('hidden');

                document.getElementById('edit-contact-id').value = '';
                document.getElementById('edit-nama').value = contact.nama || '';
                document.getElementById('edit-jabatan').value = contact.jabatan || '';
                document.getElementById('edit-perusahaan').value = contact.perusahaan || '';
                document.getElementById('edit-jenis_perusahaan').value = contact.jenis_perusahaan || '';
                document.getElementById('edit-telepon_kantor').value = contact.telepon_kantor || '';
                document.getElementById('edit-whatsapp').value = contact.whatsapp || '';
                document.getElementById('edit-email').value = contact.email || '';

                document.getElementById('edit-tags').value = (contact.tags || []).join(', ');

                document.getElementById('edit-acara').value = otherSelectors.sessionAcaraInput.value;
                document.getElementById('edit-tanggal').value = otherSelectors.sessionTanggalInput.value;
                document.getElementById('edit-catatan').value = contact.catatan || otherSelectors.sessionCatatanInput.value;

                otherSelectors.editModal.classList.remove('hidden');
                setTimeout(() => {
                    otherSelectors.editModal.classList.remove('opacity-0');
                    otherSelectors.editModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            async function openEditModal(id) {
                const contact = await dbLogic.getContact(id);
                if (!contact) return;

                document.querySelector('.app-container').classList.add('hidden');

                document.getElementById('edit-contact-id').value = contact.id;
                document.getElementById('edit-nama').value = contact.nama || '';
                document.getElementById('edit-jabatan').value = contact.jabatan || '';
                document.getElementById('edit-perusahaan').value = contact.perusahaan || '';
                document.getElementById('edit-jenis_perusahaan').value = contact.jenis_perusahaan || '';
                document.getElementById('edit-telepon_kantor').value = contact.telepon_kantor || '';
                document.getElementById('edit-whatsapp').value = contact.whatsapp || '';
                document.getElementById('edit-email').value = contact.email || '';

                document.getElementById('edit-tags').value = (contact.tags || []).join(', ');

                document.getElementById('edit-acara').value = contact.acara || '';
                document.getElementById('edit-tanggal').value = contact.tanggal || '';
                document.getElementById('edit-catatan').value = contact.catatan || '';
                otherSelectors.editModal.classList.remove('hidden');
                setTimeout(() => { otherSelectors.editModal.classList.remove('opacity-0'); otherSelectors.editModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            async function saveContactChanges() {
                const idValue = document.getElementById('edit-contact-id').value;
                const isNewContact = !idValue;

                const contactData = {
                    nama: document.getElementById('edit-nama').value,
                    jabatan: document.getElementById('edit-jabatan').value,
                    perusahaan: document.getElementById('edit-perusahaan').value,
                    jenis_perusahaan: document.getElementById('edit-jenis_perusahaan').value,
                    telepon_kantor: formatKantor(document.getElementById('edit-telepon_kantor').value),
                    whatsapp: formatWA(document.getElementById('edit-whatsapp').value),
                    email: document.getElementById('edit-email').value,
                    acara: document.getElementById('edit-acara').value,
                    tanggal: document.getElementById('edit-tanggal').value,
                    catatan: document.getElementById('edit-catatan').value,
                    tags: document.getElementById('edit-tags').value.split(',').map(tag => tag.trim()).filter(Boolean)
                };

                // ... (rest of saveContactChanges is identical)
            }

            // ... (rest of script)
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pintar | Aplikasi Scanner Kartu Nama & QR Code Berbasia AI</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar.ico" type="image/x-icon">

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#4f46e5"/>

    <!-- iOS Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Pintar">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid rgba(0,0,0,0.1); border-top-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: rgba(255,255,255,0.2); border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.6)); }
        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 80%; max-width: 320px; aspect-ratio: 1/1; border: 2px dashed rgba(255,255,255,0.5); border-radius: 1.5rem; }
        .toast { transition: opacity 0.3s ease, transform 0.3s ease; z-index: 100; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-button { padding: .75rem 1.25rem; height: 48px; display: inline-flex; align-items: center; justify-content: center; text-align: center; font-weight: 600; border-radius: .5rem; transition: all .2s ease-in-out; white-space: nowrap; }
        #scan-mode-label { transition: opacity .3s ease; }
        .btn-loader { width: 20px !important; height: 20px !important; border-width: 2px !important; }
        #qr-code-container { display: flex; justify-content: center; align-items: center; background: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        #log-icon { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; }
        #log-viewer-modal .log-entry { border-bottom: 1px solid #4a5568; }
        #log-viewer-modal .log-entry:last-child { border-bottom: none; }
        .contact-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .contact-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dark .contact-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="app-container max-w-lg mx-auto shadow-2xl min-h-screen flex flex-col bg-gray-50 dark:bg-[#0D1117] relative">
        <div id="collaboration-mode-indicator" class="hidden sticky top-0 bg-indigo-600 text-white text-xs text-center p-2 z-20 shadow-lg">
            <strong>Mode Kolaborasi:</strong> <span id="collab-session-name"></span> | <strong>User:</strong> <span id="collab-user-name"></span>
            <button id="exit-collab-btn" class="absolute top-1/2 right-2 -translate-y-1/2 font-bold text-lg text-indigo-200 hover:text-white">&times;</button>
        </div>
        
        <main class="main-content flex-grow flex flex-col">
            <div id="initial-screen" class="screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                 <div class="absolute top-5 right-5 z-10 flex items-center gap-2">
                    <button id="profile-settings-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"><i data-lucide="cog" class="w-5 h-5"></i></button>
                    <button id="theme-toggle-initial" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"><i data-lucide="sun" class="w-5 h-5"></i><i data-lucide="moon" class="w-5 h-5"></i></button>
                </div>
                <div class="w-full">
                    <div class="flex justify-center mb-8">
                        <img src="https://raw.githubusercontent.com/masisparmo/scannerkartunamallama/refs/heads/main/scanner-pintar.png" alt="Logo Scanner Pintar" class="w-24 h-24 rounded-full">
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">SCANNER PINTAR</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">Scanner Kartu Nama & QR Code Berbasis AI</p>
                </div>
                <div id="session-form-container" class="w-full text-left my-8 space-y-4">
                    <div><label for="session-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400">Nama Acara</label><input type="text" id="session-acara" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="session-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400">Tanggal</label><input type="date" id="session-tanggal" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label for="session-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Catatan</label><input type="text" id="session-catatan" placeholder="Opsional" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                    </div>
                </div>
                <div class="w-full flex flex-col gap-4">
                     <button id="start-scan-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg"><i data-lucide="camera" class="w-6 h-6"></i>SCAN KARTU NAMA</button>
                     <button id="upload-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 text-lg"><i data-lucide="image" class="w-6 h-6"></i>UPLOAD DARI GALERI</button>
                     <div class="border-t border-gray-200 dark:border-gray-700 w-3/4 mx-auto my-2"></div>
                     <button id="create-session-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center justify-center gap-3 text-base"><i data-lucide="users" class="w-5 h-5"></i>MODE KOLABURASI TIM</button>
                     <button id="view-results-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center gap-2 uppercase">Lihat Hasil Scan Kartu Nama <span id="home-contact-count" class="bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-2 py-0.5 rounded-full">0</span></button>
                </div>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
            </div>

            <div id="create-session-screen" class="hidden screen p-8 flex flex-col justify-center items-center text-center flex-grow">
                <h2 class="text-2xl font-bold">Buat Sesi Kolaborasi Baru</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2 mb-8">Masukkan nama acara untuk membuat sesi yang dapat dibagikan.</p>
                <div class="w-full max-w-sm">
                     <label for="collab-session-name-input" class="text-sm font-medium text-gray-600 dark:text-gray-400 text-left block">Nama Acara / Sesi</label>
                     <input type="text" id="collab-session-name-input" placeholder="Contoh: Pameran Konstruksi 2025" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500">
                     <div class="flex gap-4 mt-6">
                        <button id="cancel-create-session-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-full">BATAL</button>
                        <button id="generate-session-qr-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-full">Buat QR Code</button>
                     </div>
                </div>
            </div>

            <div id="profile-screen" class="hidden screen flex-col"><header class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold">Profil Saya</h2><button id="back-to-home-from-profile" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button></header><div class="p-8 space-y-4 flex-grow"><div><label for="profile-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400">Nama Anda</label><input type="text" id="profile-nama" placeholder="Cth: Isparmo" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Jabatan Anda</label><input type="text" id="profile-jabatan" placeholder="Cth: Marketing Manager" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Nama Perusahaan Anda</label><input type="text" id="profile-perusahaan" placeholder="Cth: PT Multibangun Rekatama Patria" class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="profile-deskripsi" class="text-sm font-medium text-gray-600 dark:text-gray-400">Deskripsi Singkat Perusahaan</label><textarea id="profile-deskripsi" rows="3" placeholder="Cth: Spesialis Geosintetik sejak 1995..." class="w-full mt-1 p-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea></div></div><footer class="p-6"><button id="save-profile-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full">SIMPAN PROFIL</button></footer></div>

            <div id="scanner-screen" class="hidden screen relative bg-black flex-grow"><video id="video" autoplay playsinline></video><div class="scan-frame"></div><div class="camera-overlay p-6"><div class="flex justify-between items-center"><p id="scan-mode-label" class="text-white font-medium text-sm bg-black/50 px-3 py-1 rounded-full">Arahkan ke Kartu Nama atau QR Code</p><button id="cancel-scan-btn" class="p-3 bg-black/50 rounded-full text-white hover:bg-black/80"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex justify-center items-center"><button id="capture-btn" class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-2xl ring-4 ring-white/30 transition-transform transform hover:scale-110"><i data-lucide="scan-line" class="w-10 h-10 text-indigo-600"></i></button></div></div><canvas id="canvas" class="hidden"></canvas></div>
            <div id="processing-screen" class="hidden screen justify-center items-center text-center p-8 flex-grow"><div class="loader mb-6"></div><h2 id="processing-title" class="text-2xl font-bold text-gray-900 dark:text-white animate-pulse">AI Menganalisis Gambar...</h2><p class="text-gray-500 dark:text-gray-400 mt-2">Mohon tunggu sebentar...</p></div>
            <div id="results-screen" class="hidden screen flex flex-col"><header class="p-6 flex justify-between items-center gap-4 border-b border-gray-200 dark:border-gray-700"><h2 class="text-2xl font-bold text-gray-900 dark:text-white flex-grow">Hasil Scan Lokal</h2><button id="back-to-home-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 py-2 px-4 rounded-full text-sm whitespace-nowrap">MENU UTAMA</button><button id="theme-toggle-results" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"><i data-lucide="sun" class="w-5 h-5"></i><i data-lucide="moon" class="w-5 h-5"></i></button></header><div class="flex-grow p-6 pt-4 overflow-y-auto"><p class="text-gray-600 dark:text-gray-400 mb-4">Total <span id="results-contact-count" class="font-bold">0</span> kontak tersimpan di HP ini.</p><div id="results-list" class="space-y-3"></div></div><footer id="results-footer" class="p-6 border-t border-gray-200 dark:border-gray-700"><div id="export-buttons-container" class="grid grid-cols-2 gap-4"></div><button id="clear-all-btn" class="col-span-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg mt-4 flex items-center justify-center gap-2 uppercase"><i data-lucide="trash-2" class="w-4 h-4"></i>Hapus Semua Data Lokal</button></footer></div>
        </main>
        <footer class="text-center p-6 space-y-2 text-sm text-gray-500 dark:text-gray-400">
            <div class="flex justify-center items-center gap-x-4">
                <a href="about.html" class="hover:underline hover:text-indigo-500">Tentang</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="help.html" class="hover:underline hover:text-indigo-500">Bantuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="terms.html" class="hover:underline hover:text-indigo-500">Ketentuan</a>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <a href="privacy.html" class="hover:underline hover:text-indigo-500">Privasi</a>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-600 pt-2">&copy; 2025 SCANNER PINTAR oleh Isparmo & M. Hasan</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="action-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-end sm:items-center sm:justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-md p-6 transform translate-y-full sm:scale-95 sm:translate-y-0 opacity-0"><div class="flex justify-between items-start mb-4"><div id="action-modal-header"></div><button id="close-action-modal-btn" class="p-2 -mr-2 -mt-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="action-modal-body" class="text-sm text-gray-600 dark:text-gray-400 mb-6"></div><div id="action-modal-footer" class="flex flex-wrap justify-center gap-3"></div></div></div>
    <div id="show-session-qr-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6 text-center"><h3 class="text-xl font-bold mb-2">Sesi Dibuat!</h3><p class="text-gray-600 dark:text-gray-400 mb-4">Bagikan QR Code ini ke tim Anda untuk bergabung.</p><div id="qr-code-container"></div><button id="close-qr-modal-btn" class="modal-button w-full mt-6 bg-indigo-600 text-white hover:bg-indigo-700">Selesai</button></div></div>
    <div id="join-session-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content w-full max-w-sm m-auto bg-white dark:bg-gray-800 rounded-2xl p-6"><h3 class="text-xl font-bold mb-2">Gabung Sesi Kolaborasi</h3><p class="text-gray-600 dark:text-gray-400 mb-4">Anda diundang ke sesi <strong id="join-session-name" class="text-indigo-500"></strong>. Masukkan nama Anda:</p><input type="text" id="marketing-name-input" placeholder="Nama Anda" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500"><div class="flex gap-4 mt-6"><button id="cancel-join-btn" class="modal-button flex-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300">BATAL</button><button id="confirm-join-btn" class="modal-button flex-1 bg-indigo-600 text-white hover:bg-indigo-700">Gabung</button></div></div></div>
    <div id="edit-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4 flex items-center justify-center"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0"><h3 class="text-xl font-bold mb-4">Edit Kontak</h3><form id="edit-form" class="space-y-3"><input type="hidden" id="edit-contact-id"><div class="grid grid-cols-2 gap-3"><div><label for="edit-nama" class="text-sm font-medium text-gray-600 dark:text-gray-400">Nama</label><input type="text" id="edit-nama" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jabatan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Jabatan</label><input type="text" id="edit-jabatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Perusahaan</label><input type="text" id="edit-perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-jenis_perusahaan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Jenis Perusahaan</label><input type="text" id="edit-jenis_perusahaan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-telepon_kantor" class="text-sm font-medium text-gray-600 dark:text-gray-400">Telepon Kantor</label><input type="tel" id="edit-telepon_kantor" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-whatsapp" class="text-sm font-medium text-gray-600 dark:text-gray-400">WhatsApp</label><input type="tel" id="edit-whatsapp" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div><div><label for="edit-email" class="text-sm font-medium text-gray-600 dark:text-gray-400">Email</label><input type="email" id="edit-email" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><hr class="border-gray-200 dark:border-gray-600 !my-4"><div><label for="edit-acara" class="text-sm font-medium text-gray-600 dark:text-gray-400">Acara</label><input type="text" id="edit-acara" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div class="grid grid-cols-2 gap-3"><div><label for="edit-tanggal" class="text-sm font-medium text-gray-600 dark:text-gray-400">Tanggal</label><input type="date" id="edit-tanggal" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div><div><label for="edit-catatan" class="text-sm font-medium text-gray-600 dark:text-gray-400">Catatan</label><input type="text" id="edit-catatan" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></div></div></form><div class="mt-6 flex justify-between items-center gap-3"><button id="delete-contact-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white flex-1 flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i>HAPUS</button><button id="cancel-edit-btn" class="modal-button bg-blue-600 hover:bg-blue-700 text-white flex-1">Batal</button><button id="save-edit-btn" class="modal-button bg-green-600 hover:bg-green-700 text-white flex-1">SIMPAN</button></div></div></div>
    <div id="confirm-modal" class="modal-backdrop hidden fixed inset-0 bg-black/60 z-50 p-4"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95 opacity-0"><h3 class="text-lg font-bold mb-2">Konfirmasi Tindakan</h3><p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6"></p><div class="flex justify-end items-center gap-3"><button id="cancel-confirm-btn" class="modal-button bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200">Batal</button><button id="confirm-action-btn" class="modal-button bg-red-600 hover:bg-red-700 text-white">Lanjutkan</button></div></div></div>
    <div id="toast" class="toast fixed bottom-5 right-5 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 py-3 px-5 rounded-full shadow-lg opacity-0 transform translate-y-5 pointer-events-none"><p id="toast-message"></p></div>
    
    <!-- Log Viewer Elements -->
    <button id="log-icon" class="p-2 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition-colors"><i data-lucide="terminal-square" class="w-6 h-6"></i></button>
    <div id="log-viewer-modal" class="modal-backdrop hidden fixed inset-0 bg-black/70 z-50 p-4 flex flex-col">
        <div class="modal-content w-full h-full max-w-4xl m-auto bg-gray-900 text-white rounded-lg shadow-2xl flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-bold">Frontend Error Log</h3>
                <button id="close-log-viewer-btn" class="p-1 hover:bg-gray-700 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </header>
            <div id="log-list" class="flex-grow p-4 overflow-y-auto font-mono text-sm space-y-2"></div>
            <footer class="p-3 border-t border-gray-700 flex-shrink-0 flex justify-end gap-4">
                <button id="copy-logs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-xs flex items-center gap-2"><i data-lucide="copy" class="w-4 h-4"></i>Copy Logs</button>
                <button id="clear-logs-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md text-xs">Clear Logs</button>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === KODE BARU UNTUK REGISTRASI SERVICE WORKER ===
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }
            // === AKHIR DARI KODE BARU ===

            const BACKEND_API_URL = 'https://asia-southeast1-scanner-kartu-nama-llama.cloudfunctions.net/scanner-api';
            const GSHEET_BACKEND_URL = `${BACKEND_API_URL}/simpan-gsheet`;
            const EMAIL_GENERATOR_URL = `${BACKEND_API_URL}/generateFollowUpEmail`;
            const WA_GENERATOR_URL = `${BACKEND_API_URL}/generateFollowUpWa`; // URL Endpoint Baru

            
            let collaborationSession = { isActive: false, sessionId: null, sessionAcara: null, marketingName: null };
            let errorLogs = [];

            // --- Log Viewer Selectors ---
            const logIcon = document.getElementById('log-icon');
            const logViewerModal = document.getElementById('log-viewer-modal');
            const closeLogViewerBtn = document.getElementById('close-log-viewer-btn');
            const clearLogsBtn = document.getElementById('clear-logs-btn');
            const copyLogsBtn = document.getElementById('copy-logs-btn');
            const logList = document.getElementById('log-list');

            // --- Other Selectors ---
            const createSessionBtn = document.getElementById('create-session-btn');
            const cancelCreateSessionBtn = document.getElementById('cancel-create-session-btn');
            const generateSessionQRBtn = document.getElementById('generate-session-qr-btn');
            const collabSessionNameInput = document.getElementById('collab-session-name-input');
            const showSessionQRModal = document.getElementById('show-session-qr-modal');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const closeQrModalBtn = document.getElementById('close-qr-modal-btn');
            const joinSessionModal = document.getElementById('join-session-modal');
            const joinSessionName = document.getElementById('join-session-name');
            const marketingNameInput = document.getElementById('marketing-name-input');
            const cancelJoinBtn = document.getElementById('cancel-join-btn');
            const confirmJoinBtn = document.getElementById('confirm-join-btn');
            const collaborationModeIndicator = document.getElementById('collaboration-mode-indicator');
            const collabSessionName = document.getElementById('collab-session-name');
            const collabUserName = document.getElementById('collab-user-name');
            const exitCollabBtn = document.getElementById('exit-collab-btn');
            const { ...otherSelectors } = initializeSelectors();

            function initializeSelectors() {
                return {
                    screens: { initial: document.getElementById('initial-screen'), scanner: document.getElementById('scanner-screen'), processing: document.getElementById('processing-screen'), results: document.getElementById('results-screen'), createSession: document.getElementById('create-session-screen'), profile: document.getElementById('profile-screen') },
                    startScanBtn: document.getElementById('start-scan-btn'), uploadBtn: document.getElementById('upload-btn'), viewResultsBtn: document.getElementById('view-results-btn'), imageUploadInput: document.getElementById('image-upload-input'), captureBtn: document.getElementById('capture-btn'), cancelScanBtn: document.getElementById('cancel-scan-btn'), backToHomeBtn: document.getElementById('back-to-home-btn'), exportButtonsContainer: document.getElementById('export-buttons-container'), clearAllBtn: document.getElementById('clear-all-btn'), homeContactCount: document.getElementById('home-contact-count'), resultsContactCount: document.getElementById('results-contact-count'), resultsList: document.getElementById('results-list'), video: document.getElementById('video'), canvas: document.getElementById('canvas'), toast: document.getElementById('toast'), toastMessage: document.getElementById('toast-message'), processingTitle: document.getElementById('processing-title'), sessionAcaraInput: document.getElementById('session-acara'), sessionTanggalInput: document.getElementById('session-tanggal'), sessionCatatanInput: document.getElementById('session-catatan'), editModal: document.getElementById('edit-modal'), editModalContent: document.getElementById('edit-modal').querySelector('.modal-content'), cancelEditBtn: document.getElementById('cancel-edit-btn'), saveEditBtn: document.getElementById('save-edit-btn'), deleteContactBtn: document.getElementById('delete-contact-btn'), themeToggleInitial: document.getElementById('theme-toggle-initial'), themeToggleResults: document.getElementById('theme-toggle-results'), confirmModal: document.getElementById('confirm-modal'), confirmModalContent: document.getElementById('confirm-modal').querySelector('.modal-content'), confirmMessage: document.getElementById('confirm-message'), cancelConfirmBtn: document.getElementById('cancel-confirm-btn'), confirmActionBtn: document.getElementById('confirm-action-btn'),
                    profileSettingsBtn: document.getElementById('profile-settings-btn'), backToHomeFromProfile: document.getElementById('back-to-home-from-profile'), saveProfileBtn: document.getElementById('save-profile-btn'),
                    actionModal: document.getElementById('action-modal'), actionModalContent: document.getElementById('action-modal').querySelector('.modal-content'), closeActionModalBtn: document.getElementById('close-action-modal-btn'), actionModalHeader: document.getElementById('action-modal-header'), actionModalBody: document.getElementById('action-modal-body'), actionModalFooter: document.getElementById('action-modal-footer'),
                };
            }
            
            let stream, qrScanInterval, confirmCallback = null;

            // --- Phone Number Formatting ---
            function formatKantor(phone) {
                if (!phone) return '';
                let digits = phone.replace(/\D/g, '');
                if (digits.startsWith('62')) {
                    digits = '0' + digits.substring(2);
                }
                return digits;
            }

            function formatWA(phone) {
                if (!phone) return '';
                let digits = phone.replace(/\D/g, '');
                if (digits.startsWith('0')) {
                    digits = '62' + digits.substring(1);
                }
                return digits;
            }

             // --- Log Viewer Logic (IMPROVED) ---
            function logError(message, errorObject = null) {
                console.error(message, errorObject); // Keep original console log for developers
                const timestamp = new Date().toLocaleTimeString();
                
                let details = '';
                if (errorObject) {
                    details = `Error Type: ${errorObject.name}\nMessage: ${errorObject.message}\n`;
                    if(errorObject.stack) {
                        details += `Stack Trace:\n${errorObject.stack}`;
                    }
                }

                errorLogs.push({ timestamp, message, details });
                renderLogs();
            }

            function renderLogs() {
                logList.innerHTML = '';
                if (errorLogs.length === 0) {
                    logList.innerHTML = '<p class="text-gray-500">No errors logged yet.</p>';
                } else {
                    errorLogs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry p-2';
                        const sanitizedDetails = log.details.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        logEntry.innerHTML = `
                            <p class="text-gray-400 text-xs">${log.timestamp}</p>
                            <p class="text-red-400 font-semibold">${log.message}</p>
                            <pre class="text-gray-300 text-xs whitespace-pre-wrap">${sanitizedDetails}</pre>
                        `;
                        logList.appendChild(logEntry);
                    });
                }
            }
            
            const dbLogic = {
                db: null,
                init: function() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('SmartScannerDB', 2);
                        request.onerror = (event) => { logError("Database error", event.target.error); reject("Database error"); };
                        request.onsuccess = (event) => { this.db = event.target.result; resolve(); };
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('contacts')) { 
                                db.createObjectStore('contacts', { keyPath: 'id', autoIncrement: true });
                            }
                        };
                    });
                },
                addContact: function(contact) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.add(contact); request.onsuccess = resolve; request.onerror = (e) => { logError("Add contact DB error", e.target.error); reject(e.target.error); }; }); },
                getContact: function(id) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readonly'); const store = transaction.objectStore('contacts'); const request = store.get(id); request.onsuccess = (event) => resolve(event.target.result); request.onerror = (e) => { logError("Get contact DB error", e.target.error); reject(e.target.error); }; }); },
                updateContact: function(contact) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.put(contact); request.onsuccess = resolve; request.onerror = (e) => { logError("Update contact DB error", e.target.error); reject(e.target.error); }; }); },
                deleteContact: function(id) { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.delete(id); request.onsuccess = resolve; request.onerror = (e) => { logError("Delete contact DB error", e.target.error); reject(e.target.error); }; }); },
                getAllContacts: function() { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readonly'); const store = transaction.objectStore('contacts'); const request = store.getAll(); request.onsuccess = (event) => resolve(event.target.result); request.onerror = (e) => { logError("Get all contacts DB error", e.target.error); reject(e.target.error); }; }); },
                clearAllContacts: function() { return new Promise((resolve, reject) => { const transaction = this.db.transaction(['contacts'], 'readwrite'); const store = transaction.objectStore('contacts'); const request = store.clear(); request.onsuccess = resolve; request.onerror = (e) => { logError("Clear contacts DB error", e.target.error); reject(e.target.error); }; }); }
            };
            
            function showToast(message, duration = 3000) {
                otherSelectors.toastMessage.textContent = message;
                otherSelectors.toast.classList.remove('opacity-0', 'translate-y-5');
                setTimeout(() => { otherSelectors.toast.classList.add('opacity-0', 'translate-y-5'); }, duration);
            }

            function showScreen(screenName) {
                Object.values(otherSelectors.screens).forEach(screen => { if (screen) screen.classList.add('hidden'); });
                if (otherSelectors.screens[screenName]) { otherSelectors.screens[screenName].classList.remove('hidden'); }
            }

            function applyTheme(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                [otherSelectors.themeToggleInitial, otherSelectors.themeToggleResults].forEach(toggle => {
                    const sunIcon = toggle.querySelector('[data-lucide="sun"]');
                    const moonIcon = toggle.querySelector('[data-lucide="moon"]');
                    if (isDark) { moonIcon.classList.add('hidden'); sunIcon.classList.remove('hidden'); } 
                    else { sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden'); }
                });
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }

            function toggleTheme() {
                applyTheme(!document.documentElement.classList.contains('dark'));
            }

            function showConfirmModal(message, onConfirm) {
                otherSelectors.confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                otherSelectors.confirmModal.classList.remove('hidden');
                setTimeout(() => {
                    otherSelectors.confirmModal.classList.remove('opacity-0');
                    otherSelectors.confirmModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideConfirmModal() {
                otherSelectors.confirmModal.classList.add('opacity-0');
                otherSelectors.confirmModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    otherSelectors.confirmModal.classList.add('hidden');
                    confirmCallback = null;
                }, 300);
            }

            function scanQRCode() {
                if (!otherSelectors.video.srcObject || otherSelectors.video.readyState !== otherSelectors.video.HAVE_ENOUGH_DATA) return;
                const context = otherSelectors.canvas.getContext('2d');
                otherSelectors.canvas.width = otherSelectors.video.videoWidth;
                otherSelectors.canvas.height = otherSelectors.video.videoHeight;
                context.drawImage(otherSelectors.video, 0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                const imageData = context.getImageData(0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) { 
                    stopCamera(); 
                    if (code.data.includes('?sesi=') && code.data.includes('&acara=')) {
                        window.location.href = code.data;
                    } else {
                        processQRCode(code.data); 
                    }
                }
            }

            async function startCamera() {
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); }
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    otherSelectors.video.srcObject = stream;
                    otherSelectors.video.addEventListener('loadeddata', () => {
                        if(qrScanInterval) clearInterval(qrScanInterval);
                        qrScanInterval = setInterval(scanQRCode, 500);
                    });
                    showScreen('scanner');
                } catch (err) {
                    logError("Error accessing camera:", err);
                    showToast("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.");
                    showScreen('initial');
                }
            }
            
            function stopCamera() {
                if (qrScanInterval) clearInterval(qrScanInterval);
                qrScanInterval = null;
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
            }

            function resizeImage(base64Str, maxWidth = 1024, maxHeight = 1024) {
                return new Promise((resolve) => {
                    let img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        let canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                        else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width; canvas.height = height;
                        let ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    };
                });
            }
            
            async function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const finalImageDataUrl = await resizeImage(e.target.result);
                    await processImageWithAI(finalImageDataUrl);
                };
                reader.readAsDataURL(file);
                otherSelectors.imageUploadInput.value = '';
            }

            async function captureAndProcess() {
                stopCamera();
                otherSelectors.processingTitle.textContent = "AI Menganalisis Gambar...";
                const context = otherSelectors.canvas.getContext('2d');
                otherSelectors.canvas.width = otherSelectors.video.videoWidth;
                otherSelectors.canvas.height = otherSelectors.video.videoHeight;
                context.drawImage(otherSelectors.video, 0, 0, otherSelectors.canvas.width, otherSelectors.canvas.height);
                const imageDataUrl = otherSelectors.canvas.toDataURL('image/jpeg', 0.9);
                const finalImageDataUrl = await resizeImage(imageDataUrl);
                await processImageWithAI(finalImageDataUrl);
            }

            async function processImageWithAI(imageDataUrl) {
                showScreen('processing');
                try {
                    const response = await fetch(`${BACKEND_API_URL}/processBusinessCard`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageDataUrl })
                    });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Backend Error: ${response.status}. Detail: ${errorText}`); }
                    const result = await response.json();
                    const jsonString = result.data;
                    if (jsonString) { 
                        const extractedData = JSON.parse(jsonString);
                        extractedData.telepon_kantor = formatKantor(extractedData.telepon_kantor);
                        extractedData.whatsapp = formatWA(extractedData.whatsapp);
                        saveContactData(extractedData);
                    } 
                    else { throw new Error("Respons dari Backend tidak valid."); }
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        const errorMessage = "Gagal terhubung ke server untuk scan. Ini mungkin disebabkan oleh ekstensi browser (Ad-Blocker) atau masalah jaringan. Coba di mode Incognito.";
                        logError("Processing Error (Fetch Error):", error);
                        showToast(errorMessage, 5000);
                    } else {
                        logError("Processing Error (General Error):", error);
                        showToast(`Gagal memproses gambar: ${error.message}`);
                    }
                    showScreen('initial');
                }
            }
            
            async function processQRCode(data) {
                otherSelectors.processingTitle.textContent = "Memproses QR Code...";
                showScreen('processing');
                try {
                    const contact = data.startsWith('BEGIN:VCARD') ? parseVCard(data) : { nama: 'Kontak dari QR Code', catatan: data };
                    contact.telepon_kantor = formatKantor(contact.telepon_kantor);
                    contact.whatsapp = formatWA(contact.whatsapp);
                    await saveContactData(contact);
                } catch(error) {
                    logError("QR Processing Error:", error);
                    showToast(`Gagal memproses QR Code: ${error.message}`);
                    showScreen('initial');
                }
            }

            /**
             * @param {string} vcardString The raw string content from a VCard QR code.
             * @returns {object} A contact object with parsed data.
             */
            function parseVCard(vcardString) {
                const contact = {};
                // Split lines and handle both LF (\n) and CRLF (\r\n) line endings
                const lines = vcardString.split(/[\n\r]+/);

                lines.forEach(line => {
                    // Ensure the line has a colon, otherwise it's not a valid field
                    if (!line.includes(':')) return;
                    
                    let [key, ...valueParts] = line.split(':');
                    let value = valueParts.join(':').trim();

                    // Basic parsing of the key and its parameters (e.g., TEL;TYPE=WORK)
                    const keyParts = key.split(';');
                    const mainKey = keyParts[0].toUpperCase();
                    const params = {};
                    if (keyParts.length > 1) {
                        keyParts.slice(1).forEach(p => {
                            const [paramKey, paramValue] = p.split('=');
                            if (paramKey && paramValue) {
                                // Group types, e.g., TYPE=WORK,VOICE -> {TYPE: ['WORK', 'VOICE']}
                                const pKey = paramKey.toUpperCase();
                                if (pKey === 'TYPE') {
                                    params[pKey] = (params[pKey] || []).concat(paramValue.split(','));
                                } else {
                                    params[pKey] = paramValue;
                                }
                            }
                        });
                    }

                    // Assign values to the contact object, only if the field is not already filled
                    if (mainKey === 'FN' && !contact.nama) contact.nama = value;
                    else if (mainKey === 'N' && !contact.nama) {
                        const nameParts = value.split(';');
                        contact.nama = `${nameParts[1] || ''} ${nameParts[0] || ''}`.trim();
                    }
                    else if (mainKey === 'TITLE' && !contact.jabatan) contact.jabatan = value;
                    else if (mainKey === 'ORG' && !contact.perusahaan) contact.perusahaan = value;
                    else if (mainKey === 'EMAIL' && !contact.email) contact.email = value;
                    else if (mainKey === 'CATEGORIES' && !contact.jenis_perusahaan) {
                        // This field is used for "Jenis Perusahaan"
                        contact.jenis_perusahaan = value.split(',').map(s => s.trim()).join(', ');
                    }
                    else if (mainKey === 'TEL') {
                        const types = params.TYPE || [];
                        // Check for WORK type for office phone
                        if (types.includes('WORK') && !contact.telepon_kantor) {
                            contact.telepon_kantor = value;
                        } 
                        // Check for CELL type for WhatsApp
                        else if (types.includes('CELL') && !contact.whatsapp) {
                            contact.whatsapp = value;
                        } 
                        // Fallback: if no specific numbers are assigned yet, assign the first number found to whatsapp
                        else if (!contact.telepon_kantor && !contact.whatsapp) { 
                             contact.whatsapp = value;
                        }
                    } 
                    // Support for non-standard but common X-WHATSAPP field
                    else if (mainKey === 'X-WHATSAPP' && !contact.whatsapp) {
                        contact.whatsapp = value;
                    }
                });

                return contact;
            }

            async function refreshResults() {
                const contacts = await dbLogic.getAllContacts();
                const count = contacts.length;
                otherSelectors.homeContactCount.textContent = count;
                otherSelectors.resultsContactCount.textContent = count;
                otherSelectors.resultsList.innerHTML = '';
                if (count === 0) {
                    otherSelectors.resultsList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">Belum ada data tersimpan.</p>`;
                } else {
                    contacts.reverse().forEach(contact => {
                        const card = document.createElement('div');
                        card.className = 'contact-card bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 rounded-xl';
                        card.dataset.id = contact.id;
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-3"> <p class="font-bold text-lg text-gray-900 dark:text-white">${contact.nama || 'Tanpa Nama'}</p> ${contact.jenis_perusahaan ? `<span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-100 dark:bg-indigo-900/50 px-2 py-0.5 rounded-full">${contact.jenis_perusahaan}</span>` : ''} </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${contact.jabatan || ''} di ${contact.perusahaan || ''}</p>
                                </div>
                                <button class="edit-btn p-2 text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 flex-shrink-0" data-id="${contact.id}"> <i data-lucide="edit" class="w-5 h-5"></i> </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400"> ${contact.whatsapp ? `<span>HP: ${contact.whatsapp}</span>` : ''} ${contact.email ? `<span class="ml-2">Email: ${contact.email}</span>` : ''} </div>
                            ${(contact.acara || contact.catatan) ? `<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400"> ${contact.acara ? `<p><strong>Acara:</strong> ${contact.acara} (${contact.tanggal || ''})</p>` : ''} ${contact.catatan ? `<p><strong>Catatan:</strong> ${contact.catatan}</p>` : ''} </div>` : ''}`;
                        otherSelectors.resultsList.appendChild(card);
                    });
                     document.querySelectorAll('.contact-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            if (e.target.closest('.edit-btn')) {
                                openEditModal(parseInt(e.currentTarget.dataset.id));
                            } else {
                                openActionModal(parseInt(e.currentTarget.dataset.id));
                            }
                        });
                    });
                }
                updateExportButtons(contacts);
                lucide.createIcons();
            }

            async function openActionModal(id) {
                const contact = await dbLogic.getContact(id);
                if (!contact) return;

                otherSelectors.actionModalHeader.innerHTML = `<h3 class="text-xl font-bold text-gray-900 dark:text-white">${contact.nama || 'Tanpa Nama'}</h3>`;
                otherSelectors.actionModalBody.innerHTML = `<p>${contact.jabatan || ''} di ${contact.perusahaan || ''}</p><p class="mt-1">Acara: ${contact.acara || '-'}</p>`;
                
                let footerHTML = '';
                footerHTML += `<button id="action-save-vcf" class="modal-button bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center gap-2"><i data-lucide="contact" class="w-5 h-5"></i>Simpan Kontak</button>`;
                
                if (contact.whatsapp) {
                    footerHTML += `<button id="action-whatsapp" data-wa="${contact.whatsapp}" class="modal-button bg-green-500 text-white hover:bg-green-600 flex items-center justify-center gap-2"><i data-lucide="message-circle" class="w-5 h-5"></i>Buka WA</button>`;
                    footerHTML += `<button id="action-whatsapp-ai" class="modal-button bg-teal-500 text-white hover:bg-teal-600 flex items-center justify-center gap-2"><i data-lucide="sparkles" class="w-5 h-5"></i>Draf Pesan WA</button>`;
                }

                if (contact.email) {
                    footerHTML += `<button id="action-email" class="modal-button bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center gap-2"><i data-lucide="mail" class="w-5 h-5"></i>Draf Email</button>`;
                }
                
                otherSelectors.actionModalFooter.innerHTML = footerHTML;
                lucide.createIcons();
                
                document.getElementById('action-save-vcf').addEventListener('click', () => exportVCF(contact));
                
                if(contact.whatsapp) {
                    document.getElementById('action-whatsapp').addEventListener('click', (e) => {
                         const waNumber = e.currentTarget.dataset.wa;
                         const url = `https://wa.me/${waNumber}`;
                         window.open(url, '_blank');
                    });
                    document.getElementById('action-whatsapp-ai').addEventListener('click', () => generateAndOpenWa(contact));
                }

                if(contact.email && document.getElementById('action-email')) {
                    document.getElementById('action-email').addEventListener('click', () => generateAndOpenEmail(contact));
                }

                otherSelectors.actionModal.classList.remove('hidden');
                setTimeout(() => { 
                    otherSelectors.actionModal.classList.remove('opacity-0');
                    otherSelectors.actionModalContent.classList.remove('translate-y-full', 'sm:scale-95', 'sm:translate-y-0', 'opacity-0'); 
                }, 10);
            }
            
            async function generateAndOpenEmail(contact) {
                 const profile = JSON.parse(localStorage.getItem('userProfile'));
                if (!profile || !profile.nama || !profile.jabatan || !profile.perusahaan) {
                    showToast("Harap lengkapi profil Anda di menu Pengaturan terlebih dahulu."); return;
                }

                const emailBtn = document.getElementById('action-email');
                const originalBtnHTML = emailBtn.innerHTML;
                emailBtn.disabled = true;
                emailBtn.innerHTML = `<div class="loader btn-loader"></div>`;
                
                try {
                    const response = await fetch(EMAIL_GENERATOR_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact, profile })
                    });
                    
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Gagal membuat draf email. Status: ${response.status}. Detail: ${errorText}`); }
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        const emailData = JSON.parse(result.data);
                        const subject = encodeURIComponent(emailData.subject || `Perkenalan dari ${profile.perusahaan}`);
                        const body = encodeURIComponent(emailData.body || '');
                        window.location.href = `mailto:${contact.email}?subject=${subject}&body=${body}`;
                    } else { throw new Error('Respons AI tidak valid.'); }
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        const errorMessage = "Gagal terhubung ke server. Ini mungkin disebabkan oleh ekstensi browser (Ad-Blocker) atau masalah jaringan.";
                        logError("Gagal generate email (Fetch Error):", error);
                        showToast(errorMessage, 5000);
                    } else {
                        logError("Gagal generate email (General Error):", error);
                        showToast(error.message);
                    }
                } finally {
                    emailBtn.disabled = false;
                    emailBtn.innerHTML = originalBtnHTML;
                    lucide.createIcons();
                }
            }

            async function generateAndOpenWa(contact) {
                const profile = JSON.parse(localStorage.getItem('userProfile'));
                if (!profile || !profile.nama) {
                    showToast("Harap lengkapi profil Anda di menu Pengaturan terlebih dahulu."); return;
                }

                const waAiBtn = document.getElementById('action-whatsapp-ai');
                const originalBtnHTML = waAiBtn.innerHTML;
                waAiBtn.disabled = true;
                waAiBtn.innerHTML = `<div class="loader btn-loader"></div>`;
                
                try {
                    const response = await fetch(WA_GENERATOR_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact, profile })
                    });
                    
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Gagal membuat draf WA. Status: ${response.status}. Detail: ${errorText}`); }
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        const message = encodeURIComponent(result.data);
                        const waNumber = formatWA(contact.whatsapp);
                        const url = `https://wa.me/${waNumber}?text=${message}`;
                        window.open(url, '_blank');
                        closeActionModal();
                    } else { throw new Error('Respons AI untuk WA tidak valid.'); }
                } catch (error) {
                    logError("Gagal generate pesan WA:", error);
                    showToast(error.message);
                } finally {
                    waAiBtn.disabled = false;
                    waAiBtn.innerHTML = originalBtnHTML;
                    lucide.createIcons();
                }
            }

            function closeActionModal() {
                 otherSelectors.actionModal.classList.add('opacity-0');
                 otherSelectors.actionModalContent.classList.add('translate-y-full', 'sm:scale-95', 'sm:translate-y-0', 'opacity-0');
                setTimeout(() => { otherSelectors.actionModal.classList.add('hidden'); }, 300);
            }

            async function openEditModal(id) {
                const contact = await dbLogic.getContact(id);
                if (!contact) return;
                
                document.querySelector('.app-container').classList.add('hidden');
                
                document.getElementById('edit-contact-id').value = contact.id;
                document.getElementById('edit-nama').value = contact.nama || '';
                document.getElementById('edit-jabatan').value = contact.jabatan || '';
                document.getElementById('edit-perusahaan').value = contact.perusahaan || '';
                document.getElementById('edit-jenis_perusahaan').value = contact.jenis_perusahaan || '';
                document.getElementById('edit-telepon_kantor').value = contact.telepon_kantor || '';
                document.getElementById('edit-whatsapp').value = contact.whatsapp || '';
                document.getElementById('edit-email').value = contact.email || '';
                document.getElementById('edit-acara').value = contact.acara || '';
                document.getElementById('edit-tanggal').value = contact.tanggal || '';
                document.getElementById('edit-catatan').value = contact.catatan || '';
                otherSelectors.editModal.classList.remove('hidden');
                setTimeout(() => { otherSelectors.editModal.classList.remove('opacity-0'); otherSelectors.editModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            function closeEditModal() {
                otherSelectors.editModal.classList.add('opacity-0');
                otherSelectors.editModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    otherSelectors.editModal.classList.add('hidden');
                    document.querySelector('.app-container').classList.remove('hidden');
                }, 300);
            }

            async function saveContactChanges() {
                const id = parseInt(document.getElementById('edit-contact-id').value);
                const updatedContact = {
                    id: id,
                    nama: document.getElementById('edit-nama').value,
                    jabatan: document.getElementById('edit-jabatan').value,
                    perusahaan: document.getElementById('edit-perusahaan').value,
                    jenis_perusahaan: document.getElementById('edit-jenis_perusahaan').value,
                    telepon_kantor: formatKantor(document.getElementById('edit-telepon_kantor').value),
                    whatsapp: formatWA(document.getElementById('edit-whatsapp').value),
                    email: document.getElementById('edit-email').value,
                    acara: document.getElementById('edit-acara').value,
                    tanggal: document.getElementById('edit-tanggal').value,
                    catatan: document.getElementById('edit-catatan').value,
                };
                await dbLogic.updateContact(updatedContact);
                showToast("Kontak berhasil diperbarui!");
                closeEditModal();
                await refreshResults();
            }

            async function handleDeleteContact() {
                const id = parseInt(document.getElementById('edit-contact-id').value);
                showConfirmModal(
                    "Apakah Anda yakin ingin menghapus kontak ini? Tindakan ini tidak dapat dibatalkan.",
                    async () => {
                        try {
                            await dbLogic.deleteContact(id);
                            showToast("Kontak berhasil dihapus.");
                            closeEditModal();
                            await refreshResults();
                        } catch (error) { logError("Gagal menghapus kontak:", error); showToast("Gagal menghapus kontak."); }
                    }
                );
            }
            
            function setupCollaborationModeUI() {
                collaborationSession.isActive = true;
                document.getElementById('session-form-container').classList.add('opacity-50', 'pointer-events-none');
                createSessionBtn.classList.add('hidden');
                
                collaborationModeIndicator.classList.remove('hidden');
                collabSessionName.textContent = collaborationSession.sessionAcara;
                collabUserName.textContent = collaborationSession.marketingName;

                otherSelectors.sessionAcaraInput.value = collaborationSession.sessionAcara;
                otherSelectors.sessionTanggalInput.value = new Date().toISOString().slice(0, 10);
            }

            function exitCollaborationMode() {
                showConfirmModal("Anda yakin ingin keluar dari sesi kolaborasi?", () => {
                    localStorage.removeItem('collaborationSession');
                    collaborationSession = { isActive: false, sessionId: null, sessionAcara: null, marketingName: null };
                    
                    const url = new URL(window.location);
                    url.searchParams.delete('sesi');
                    url.searchParams.delete('acara');
                    window.history.pushState({}, '', url);

                    collaborationModeIndicator.classList.add('hidden');
                    document.getElementById('session-form-container').classList.remove('opacity-50', 'pointer-events-none');
                    createSessionBtn.classList.remove('hidden');
                    showToast("Keluar dari mode kolaborasi.");
                });
            }

            async function saveContactData(contactData) {
                contactData.telepon_kantor = formatKantor(contactData.telepon_kantor);
                contactData.whatsapp = formatWA(contactData.whatsapp);

                contactData.acara = otherSelectors.sessionAcaraInput.value;
                contactData.tanggal = otherSelectors.sessionTanggalInput.value;
                contactData.catatan = contactData.catatan || otherSelectors.sessionCatatanInput.value;

                await dbLogic.addContact(contactData);
                await refreshResults();
                showScreen('results');

                if (collaborationSession.isActive) {
                    showToast('Kontak disimpan lokal. Mengirim ke Google Sheet...');
                    sendCollaborativeData({ ...contactData, marketingName: collaborationSession.marketingName });
                } else {
                    showToast('Kontak berhasil disimpan di HP Anda.');
                }
            }
            
            async function sendCollaborativeData(contact) {
                try {
                    const response = await fetch(GSHEET_BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contact: contact })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.error || 'Gagal mengirim data.');
                    showToast(`Data terkirim ke Google Sheet: ${contact.nama}`);
                } catch (error) {
                    logError("Failed to send collaborative data", error);
                    showToast(`Gagal kirim: ${contact.nama}. Data aman di lokal.`);
                }
            }
            
            function updateExportButtons(contacts) {
                let buttonsHTML = '';
                if (collaborationSession.isActive) {
                    buttonsHTML = `
                        <p class="col-span-2 text-xs text-center text-gray-500 dark:text-gray-400">Data otomatis terkirim ke G-Sheet. Opsi ekspor di bawah hanya untuk data di HP ini.</p>
                        <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i>SIMPAN .csv</button>
                        <button id="export-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="archive" class="w-5 h-5"></i>SIMPAN VCF .zip</button>
                    `;
                } else {
                    if (contacts.length === 1) {
                        buttonsHTML = `
                            <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i>SIMPAN .csv</button>
                            <button id="export-vcf-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="contact" class="w-5 h-5"></i>SIMPAN .vcf</button>
                        `;
                    } else if (contacts.length > 1) {
                         buttonsHTML = `
                            <button id="export-csv-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i>SIMPAN .csv</button>
                            <button id="export-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base"><i data-lucide="archive" class="w-5 h-5"></i>SIMPAN VCF .zip</button>
                        `;
                    }
                    if (contacts.length > 0) {
                        buttonsHTML += `
                            <button id="export-gsheet-btn" class="col-span-2 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-base mt-2">
                                <i data-lucide="sheet" class="w-5 h-5"></i>SIMPAN KE GOOGLE SHEET
                            </button>
                        `;
                    }
                }
                otherSelectors.exportButtonsContainer.innerHTML = buttonsHTML;
                lucide.createIcons();
                
                if (contacts.length > 0) {
                    if (document.getElementById('export-csv-btn')) document.getElementById('export-csv-btn').addEventListener('click', () => exportCSV(contacts));
                    if (document.getElementById('export-vcf-btn')) document.getElementById('export-vcf-btn').addEventListener('click', () => exportVCF(contacts[0]));
                    if (document.getElementById('export-zip-btn')) document.getElementById('export-zip-btn').addEventListener('click', () => exportZIP(contacts));
                    if (document.getElementById('export-gsheet-btn')) {
                         const gsheetBtn = document.getElementById('export-gsheet-btn');
                         gsheetBtn.addEventListener('click', () => saveAllToGoogleSheet(gsheetBtn));
                    }
                }
            }

            async function saveAllToGoogleSheet(button) {
                 const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<div class="loader btn-loader"></div><span class="ml-2">Menyimpan...</span>`;
                try {
                    const contacts = await dbLogic.getAllContacts();
                    if (contacts.length === 0) { showToast("Tidak ada kontak untuk disimpan."); return; }
                    const response = await fetch(GSHEET_BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contacts: contacts })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.error || 'Gagal menyimpan data.');
                    showToast(result.message || `${contacts.length} kontak berhasil disimpan.`);
                } catch (error) {
                    logError("Error saving all to Google Sheet", error);
                    showToast(`Error: ${error.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    lucide.createIcons();
                }
            }

            function exportCSV(contacts) {
                if (contacts.length === 0) { showToast("Tidak ada data untuk diekspor."); return; }
                const headers = ['Nama', 'Jabatan', 'Perusahaan', 'Jenis Perusahaan', 'Telepon Kantor', 'WhatsApp', 'Email', 'Acara', 'Tanggal', 'Catatan'];
                let csvContent = headers.join(',') + '\n';
                const escapeCSV = (field) => `"${String(field || '').replace(/"/g, '""')}"`;
                contacts.forEach(c => {
                    const row = [c.nama, c.jabatan, c.perusahaan, c.jenis_perusahaan, c.telepon_kantor, c.whatsapp, c.email, c.acara, c.tanggal, c.catatan];
                    csvContent += row.map(escapeCSV).join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `kontak_kartunama_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                showToast("File CSV sedang diunduh.");
            }

            function createVCardString(contact) {
                let vCard = `BEGIN:VCARD\nVERSION:3.0\nFN:${contact.nama || ''}\nORG:${contact.perusahaan || ''}\nTITLE:${contact.jabatan || ''}\n`;
                if(contact.jenis_perusahaan) vCard += `CATEGORIES:${contact.jenis_perusahaan}\n`;
                if (contact.telepon_kantor) vCard += `TEL;TYPE=WORK,VOICE:${contact.telepon_kantor}\n`;
                if (contact.whatsapp) vCard += `TEL;TYPE=CELL,VOICE:${contact.whatsapp}\n`;
                if (contact.email) vCard += `EMAIL:${contact.email}\n`;
                let note = [];
                if (contact.acara) note.push(`Acara: ${contact.acara} (${contact.tanggal || ''})`);
                if (contact.catatan) note.push(`Catatan: ${contact.catatan}`);
                if (note.length > 0) vCard += `NOTE:${note.join(' | ')}\n`;
                vCard += `END:VCARD`;
                return vCard;
            }

            function exportVCF(contact) {
                const vCardString = createVCardString(contact);
                const blob = new Blob([vCardString], { type: 'text/vcard;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                const filename = (contact.nama || `kontak`).replace(/\s+/g, '_').toLowerCase();
                link.download = `${filename}.vcf`;
                link.click();
                showToast("File VCF sedang diunduh.");
            }

            function exportZIP(contacts) {
                if (contacts.length === 0) { showToast("Tidak ada data untuk diekspor."); return; }
                const zip = new JSZip();
                contacts.forEach((c, i) => {
                    const vCardString = createVCardString(c);
                    const filename = (c.nama || `kontak_${i + 1}`).replace(/\s+/g, '_').toLowerCase() + '.vcf';
                    zip.file(filename, vCardString);
                });
                zip.generateAsync({ type: "blob" }).then(content => {
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(content);
                    link.download = `kontak_vcf_${new Date().toISOString().slice(0,10)}.zip`;
                    link.click();
                    showToast("File ZIP sedang diunduh.");
                });
            }
            
            function loadAndDisplayProfile() {
                const profile = JSON.parse(localStorage.getItem('userProfile')) || {};
                document.getElementById('profile-nama').value = profile.nama || '';
                document.getElementById('profile-jabatan').value = profile.jabatan || '';
                document.getElementById('profile-perusahaan').value = profile.perusahaan || '';
                document.getElementById('profile-deskripsi').value = profile.deskripsi || '';
            }

            async function initializeApp() {
                lucide.createIcons();
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedTheme ? savedTheme === 'dark' : prefersDark);
                otherSelectors.sessionAcaraInput.value = localStorage.getItem('sessionAcara') || '';
                otherSelectors.sessionTanggalInput.value = localStorage.getItem('sessionTanggal') || new Date().toISOString().slice(0, 10);
                otherSelectors.sessionCatatanInput.value = localStorage.getItem('sessionCatatan') || '';

                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('sesi');
                const sessionAcaraFromUrl = urlParams.get('acara');

                const savedSession = JSON.parse(localStorage.getItem('collaborationSession'));

                if (sessionIdFromUrl && sessionAcaraFromUrl) {
                    if (savedSession && savedSession.sessionId === sessionIdFromUrl && savedSession.marketingName) {
                        collaborationSession = savedSession;
                        setupCollaborationModeUI();
                    } else {
                        joinSessionName.textContent = sessionAcaraFromUrl;
                        joinSessionModal.classList.remove('hidden');
                    }
                } else if (savedSession) {
                     collaborationSession = savedSession;
                     setupCollaborationModeUI();
                }
                
                try {
                    await dbLogic.init();
                    await refreshResults();
                    showScreen('initial');
                } catch (error) {
                    logError("Failed to initialize the app", error);
                    document.body.innerHTML = `<div class="text-center p-8 text-red-500">Gagal memuat database. Aplikasi tidak dapat berjalan.</div>`;
                }
            }
            
            // Event Listeners
            createSessionBtn.addEventListener('click', () => showScreen('createSession'));
            cancelCreateSessionBtn.addEventListener('click', () => showScreen('initial'));
            
            generateSessionQRBtn.addEventListener('click', () => {
                const acara = collabSessionNameInput.value.trim();
                if (!acara) { showToast("Nama acara tidak boleh kosong."); return; }
                const sessionId = acara.replace(/\s+/g, '-') + '-' + Date.now().toString(36);
                const baseUrl = window.location.origin + window.location.pathname;
                const collabUrl = `${baseUrl}?sesi=${sessionId}&acara=${encodeURIComponent(acara)}`;
                qrCodeContainer.innerHTML = '';
                new QRCode(qrCodeContainer, { text: collabUrl, width: 256, height: 256 });
                showSessionQRModal.classList.remove('hidden');
            });
            
            closeQrModalBtn.addEventListener('click', () => {
                showSessionQRModal.classList.add('hidden');
                showScreen('initial');
            });
            
            confirmJoinBtn.addEventListener('click', () => {
                const marketingName = marketingNameInput.value.trim();
                if (!marketingName) { showToast("Nama marketing tidak boleh kosong."); return; }
                const urlParams = new URLSearchParams(window.location.search);
                collaborationSession = {
                    isActive: true,
                    sessionId: urlParams.get('sesi'),
                    sessionAcara: urlParams.get('acara'),
                    marketingName: marketingName
                };
                localStorage.setItem('collaborationSession', JSON.stringify(collaborationSession));
                joinSessionModal.classList.add('hidden');
                setupCollaborationModeUI();
                showToast(`Selamat datang, ${marketingName}!`);
            });

            cancelJoinBtn.addEventListener('click', () => {
                joinSessionModal.classList.add('hidden');
                const url = new URL(window.location);
                url.searchParams.delete('sesi');
                url.searchParams.delete('acara');
                window.history.pushState({}, '', url);
                showScreen('initial');
            });

            exitCollabBtn.addEventListener('click', exitCollaborationMode);
            otherSelectors.startScanBtn.addEventListener('click', startCamera);
            otherSelectors.uploadBtn.addEventListener('click', () => otherSelectors.imageUploadInput.click());
            otherSelectors.imageUploadInput.addEventListener('change', handleImageUpload);
            otherSelectors.captureBtn.addEventListener('click', captureAndProcess);
            otherSelectors.cancelScanBtn.addEventListener('click', () => { stopCamera(); showScreen('initial'); });
            otherSelectors.viewResultsBtn.addEventListener('click', () => showScreen('results'));
            otherSelectors.backToHomeBtn.addEventListener('click', () => showScreen('initial'));
            otherSelectors.clearAllBtn.addEventListener('click', () => {
                showConfirmModal("Anda yakin ingin menghapus semua data LOKAL? Tindakan ini tidak akan menghapus data di Google Sheet.",
                    async () => {
                        await dbLogic.clearAllContacts();
                        await refreshResults();
                        showToast("Semua data lokal telah dihapus.");
                    }
                );
            });
            otherSelectors.saveEditBtn.addEventListener('click', saveContactChanges);
            otherSelectors.cancelEditBtn.addEventListener('click', closeEditModal);
            otherSelectors.deleteContactBtn.addEventListener('click', handleDeleteContact);
            [otherSelectors.themeToggleInitial, otherSelectors.themeToggleResults].forEach(btn => btn.addEventListener('click', toggleTheme));
            otherSelectors.sessionAcaraInput.addEventListener('input', (e) => localStorage.setItem('sessionAcara', e.target.value));
            otherSelectors.sessionTanggalInput.addEventListener('input', (e) => localStorage.setItem('sessionTanggal', e.target.value));
            otherSelectors.sessionCatatanInput.addEventListener('input', (e) => localStorage.setItem('sessionCatatan', e.target.value));
            otherSelectors.cancelConfirmBtn.addEventListener('click', hideConfirmModal);
            otherSelectors.confirmActionBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            // --- Profile Screen Listeners ---
            otherSelectors.profileSettingsBtn.addEventListener('click', () => {
                loadAndDisplayProfile();
                showScreen('profile');
            });
            otherSelectors.backToHomeFromProfile.addEventListener('click', () => showScreen('initial'));
            otherSelectors.saveProfileBtn.addEventListener('click', () => {
                const profile = {
                    nama: document.getElementById('profile-nama').value,
                    jabatan: document.getElementById('profile-jabatan').value,
                    perusahaan: document.getElementById('profile-perusahaan').value,
                    deskripsi: document.getElementById('profile-deskripsi').value,
                };
                localStorage.setItem('userProfile', JSON.stringify(profile));
                showToast("Profil berhasil disimpan!");
                showScreen('initial');
            });
            otherSelectors.closeActionModalBtn.addEventListener('click', closeActionModal);


            // Log Viewer Event Listeners
            logIcon.addEventListener('click', () => {
                logViewerModal.classList.remove('hidden');
                lucide.createIcons();
            });
            closeLogViewerBtn.addEventListener('click', () => logViewerModal.classList.add('hidden'));
            clearLogsBtn.addEventListener('click', () => {
                errorLogs = [];
                renderLogs();
            });
            copyLogsBtn.addEventListener('click', () => {
                if (errorLogs.length === 0) {
                    showToast('No logs to copy.');
                    return;
                }
                const logText = errorLogs.map(log => `[${log.timestamp}] ${log.message}\n${log.details}`).join('\n\n');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(logText).then(() => {
                        showToast('Logs copied to clipboard!');
                    }).catch(err => {
                        logError('Failed to copy logs with Clipboard API', err);
                        showToast('Could not copy logs.');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = logText;
                    textArea.style.position = 'fixed';  textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Logs copied to clipboard!');
                    } catch (err) {
                        logError('Failed to copy logs with fallback', err);
                        showToast('Could not copy logs.');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
            });


            initializeApp();
        });
    </script>
</body>
</html>





